<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>True Chats</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f0f2f5; transition: all 0.5s ease; }
        
        /* Private/Love Mode Styles */
        .love-theme {
            background: linear-gradient(135deg, #ffe6e6 0%, #ffb3b3 100%);
            color: #4a0018;
        }
        .love-theme .header { background-color: #ff4d6d; }
        .love-theme .chat-bubble-sent { background-color: #ff4d6d; }
        
        /* Floating Hearts Animation */
        .heart-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 0; overflow: hidden; display: none;
        }
        .love-theme .heart-bg { display: block; }
        .heart {
            position: absolute; bottom: -10px;
            animation: float 6s linear infinite; opacity: 0.6;
            color: #ff0040; font-size: 20px;
        }
        @keyframes float {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(-100vh) rotate(360deg); opacity: 0; }
        }

        /* Utility Classes */
        .hidden { display: none !important; }
        .red-dot {
            width: 10px; height: 10px; background-color: red;
            border-radius: 50%; position: absolute; top: 0; right: 0;
            border: 2px solid white;
        }
        .blue-tick { color: #3498db; }
        .grey-tick { color: #aaa; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 5px; }
    </style>
</head>
<body id="mainBody">

    <div id="heartsContainer" class="heart-bg"></div>

    <div id="loginScreen" class="h-screen flex flex-col items-center justify-center bg-white p-6">
        <h1 class="text-3xl font-bold text-blue-600 mb-6">True Chats ðŸ’¬</h1>
        <input type="email" id="emailInput" placeholder="Email" class="w-full p-3 border rounded mb-3">
        <input type="password" id="passInput" placeholder="Password" class="w-full p-3 border rounded mb-3">
        <button onclick="login()" class="w-full bg-blue-600 text-white p-3 rounded font-bold mb-2">Login</button>
        <button onclick="register()" class="w-full bg-green-500 text-white p-3 rounded font-bold">Create Account</button>
        <p id="authError" class="text-red-500 mt-2 text-sm"></p>
    </div>

    <div id="appScreen" class="hidden h-screen flex flex-col">
        
        <div class="header bg-white p-3 shadow-md flex justify-between items-center z-10">
            <div class="flex items-center gap-2">
                <h1 class="text-xl font-bold text-blue-600" id="appTitle">True Chats</h1>
            </div>
            
            <div class="flex items-center gap-4">
                <div onclick="togglePrivateMode()" class="cursor-pointer text-2xl transition transform active:scale-90">
                    <i id="modeIcon" class="fa-regular fa-heart text-gray-400"></i>
                </div>
                
                <div class="relative cursor-pointer" onclick="showSection('requests')">
                    <i class="fa-solid fa-user-plus text-xl text-gray-600"></i>
                    <div id="requestDot" class="hidden red-dot"></div>
                </div>

                <div class="relative">
                    <img id="myDp" src="https://via.placeholder.com/40" class="w-9 h-9 rounded-full border border-gray-300 object-cover" onclick="toggleMenu('mainMenu')">
                    
                    <div id="mainMenu" class="hidden absolute right-0 mt-2 w-48 bg-white shadow-xl rounded-lg border z-50">
                        <div class="p-3 border-b text-center">
                            <p id="myUsernameDisplay" class="font-bold text-sm">User</p>
                            <p id="friendCountDisplay" class="text-xs text-gray-500">Friends: 0</p>
                        </div>
                        <div class="p-2 text-sm">
                            <div onclick="changeUsername()" class="p-2 hover:bg-gray-100 cursor-pointer">Change Username</div>
                            <div onclick="changePassword()" class="p-2 hover:bg-gray-100 cursor-pointer">Change Password</div>
                            <div onclick="logout()" class="p-2 hover:bg-gray-100 cursor-pointer text-red-500">Logout</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="p-3 bg-white border-b">
            <input type="text" id="searchInput" onkeyup="searchUsers()" placeholder="Search friends by keyword..." class="w-full bg-gray-100 p-2 rounded-full px-4 outline-none">
        </div>

        <div class="flex-1 overflow-y-auto p-2" id="mainContent">
            
            <div id="chatsListSection">
                </div>

            <div id="searchResultsSection" class="hidden">
                <h3 class="text-sm text-gray-500 mb-2">Search Results</h3>
                <div id="usersList"></div>
            </div>

            <div id="requestsSection" class="hidden">
                <h3 class="text-sm text-gray-500 mb-2">Friend Requests</h3>
                <div id="requestsList"></div>
            </div>
        </div>

        <div id="chatWindow" class="hidden fixed top-0 left-0 w-full h-full bg-white z-20 flex flex-col">
            <div class="bg-gray-100 p-2 flex justify-between items-center shadow-sm">
                <div class="flex items-center gap-2">
                    <i onclick="closeChat()" class="fa-solid fa-arrow-left text-xl p-2 cursor-pointer"></i>
                    <img id="chatUserDp" src="" class="w-10 h-10 rounded-full object-cover">
                    <div>
                        <h3 id="chatUserName" class="font-bold text-sm">User</h3>
                        <p id="chatUserStatus" class="text-xs text-green-500">Online</p>
                    </div>
                </div>
                <div class="flex items-center gap-4 text-xl text-blue-600">
                    <i onclick="startCall('audio')" class="fa-solid fa-phone"></i>
                    <i onclick="startCall('video')" class="fa-solid fa-video"></i>
                    
                    <div class="relative">
                        <div onclick="toggleMenu('chatMenu')" class="cursor-pointer grid grid-cols-2 gap-0.5 w-4">
                            <div class="w-1 h-1 bg-black rounded-full"></div><div class="w-1 h-1 bg-black rounded-full"></div>
                            <div class="w-1 h-1 bg-black rounded-full"></div><div class="w-1 h-1 bg-black rounded-full"></div>
                        </div>
                        <div id="chatMenu" class="hidden absolute right-0 mt-2 w-48 bg-white shadow-xl rounded z-50 text-sm text-black">
                            <div onclick="blockUser()" class="p-3 hover:bg-gray-100 border-b">Block User</div>
                            <div onclick="muteChat()" class="p-3 hover:bg-gray-100 border-b">Mute Notifications</div>
                            <div onclick="toggleHideChat()" class="p-3 hover:bg-gray-100 border-b flex justify-between">
                                <span>Private Mode</span> <i class="fa-solid fa-eye-slash"></i>
                            </div>
                            <div onclick="clearChat()" class="p-3 hover:bg-gray-100 text-red-500">Clear Chat</div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="messagesContainer" class="flex-1 overflow-y-auto p-4 bg-gray-50 flex flex-col gap-2">
                </div>

            <div class="p-2 border-t flex items-center gap-2 bg-white">
                <input type="text" id="msgInput" placeholder="Type a message..." class="flex-1 p-2 border rounded-full outline-none">
                <div class="text-2xl text-gray-500 flex gap-2">
                   <i class="fa-solid fa-camera"></i>
                </div>
                <button onclick="sendMessage()" class="bg-blue-600 text-white w-10 h-10 rounded-full flex items-center justify-center">
                    <i class="fa-solid fa-paper-plane"></i>
                </button>
            </div>
            
            <div id="msgOptionsModal" class="hidden fixed bottom-0 w-full bg-white shadow-[0_-5px_20px_rgba(0,0,0,0.1)] rounded-t-xl p-4 z-50">
                <div onclick="editMessage()" id="editOption" class="p-3 border-b text-center text-blue-600 font-bold">Edit Message</div>
                <div onclick="deleteMessage('unseen')" id="unseenOption" class="p-3 border-b text-center">Unseen</div>
                <div onclick="deleteMessage('me')" class="p-3 text-center text-red-500">Delete for Me</div>
                <button onclick="document.getElementById('msgOptionsModal').classList.add('hidden')" class="w-full mt-2 p-2 bg-gray-200 rounded">Cancel</button>
            </div>
        </div>
        
        <div id="callOverlay" class="hidden fixed top-0 left-0 w-full h-full bg-black z-50 flex flex-col items-center justify-center text-white">
            <img id="callUserImg" src="" class="w-24 h-24 rounded-full border-4 border-white mb-4 animate-pulse">
            <h2 id="callUserName" class="text-2xl font-bold">Calling...</h2>
            <p class="text-sm mb-10">Ringing</p>
            <div class="flex gap-10">
                <button onclick="endCall()" class="bg-red-600 p-4 rounded-full text-2xl"><i class="fa-solid fa-phone-slash"></i></button>
            </div>
        </div>

    </div>
        <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, orderBy, doc, updateDoc, arrayUnion, getDoc, setDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // Your Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCAsCm1YcsAjHwyvIzxyMrBmZPLw2hlo18",
            authDomain: "truechats-8dac9.firebaseapp.com",
            projectId: "truechats-8dac9",
            storageBucket: "truechats-8dac9.firebasestorage.app",
            messagingSenderId: "685374771914",
            appId: "1:685374771914:web:81bf491264c1bb09061a33",
            measurementId: "G-7E9QE7G5SQ"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global Variables
        window.currentUser = null;
        window.currentChatId = null;
        window.selectedMsgId = null;
        window.privateMode = false;
        
        // --- AUTHENTICATION ---
        window.login = async () => {
            const e = document.getElementById('emailInput').value;
            const p = document.getElementById('passInput').value;
            try {
                await signInWithEmailAndPassword(auth, e, p);
            } catch (err) { alert(err.message); }
        };

        window.register = async () => {
            const e = document.getElementById('emailInput').value;
            const p = document.getElementById('passInput').value;
            try {
                const res = await createUserWithEmailAndPassword(auth, e, p);
                // Create user doc
                await setDoc(doc(db, "users", res.user.uid), {
                    username: e.split('@')[0],
                    email: e,
                    uid: res.user.uid,
                    friends: [],
                    requests: [],
                    photoURL: "https://ui-avatars.com/api/?name=" + e.split('@')[0],
                    isOnline: true,
                    privatePassword: null // Will be set later
                });
                alert("Account created! Please login.");
            } catch (err) { alert(err.message); }
        };

        window.logout = () => signOut(auth);

        onAuthStateChanged(auth, (user) => {
            if (user) {
                window.currentUser = user;
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('appScreen').classList.remove('hidden');
                loadUserData();
                loadChats();
                listenForRequests();
            } else {
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('appScreen').classList.add('hidden');
            }
        });

        // --- HELPER FUNCTIONS ---
        // Expose functions to window so HTML onclick works
        window.toggleMenu = (id) => { document.getElementById(id).classList.toggle('hidden'); };
        window.showSection = (sec) => {
            document.getElementById('chatsListSection').classList.add('hidden');
            document.getElementById('requestsSection').classList.add('hidden');
            document.getElementById('searchResultsSection').classList.add('hidden');
            if(sec === 'requests') document.getElementById('requestsSection').classList.remove('hidden');
        };
        
                // --- DATA LOADING & SEARCH ---
        async function loadUserData() {
            const userDoc = await getDoc(doc(db, "users", window.currentUser.uid));
            if (userDoc.exists()) {
                const data = userDoc.data();
                document.getElementById('myUsernameDisplay').innerText = data.username;
                document.getElementById('friendCountDisplay').innerText = `Friends: ${data.friends.length}`;
                document.getElementById('myDp').src = data.photoURL;
            }
        }

        window.searchUsers = async () => {
            const input = document.getElementById('searchInput').value;
            if (input.length < 3) return;
            document.getElementById('chatsListSection').classList.add('hidden');
            document.getElementById('searchResultsSection').classList.remove('hidden');
            
            const q = query(collection(db, "users"), where("username", ">=", input), where("username", "<=", input + '\uf8ff'));
            const querySnapshot = await onSnapshot(q, (snap) => {
                const list = document.getElementById('usersList');
                list.innerHTML = "";
                snap.forEach((docSnap) => {
                    const u = docSnap.data();
                    if(u.uid !== window.currentUser.uid) {
                        list.innerHTML += `
                        <div class="flex justify-between items-center p-3 bg-white border-b">
                            <div class="flex items-center gap-3">
                                <img src="${u.photoURL}" class="w-10 h-10 rounded-full">
                                <span>${u.username}</span>
                            </div>
                            <button onclick="sendRequest('${u.uid}')" class="bg-blue-500 text-white px-3 py-1 rounded text-xs">Add</button>
                        </div>`;
                    }
                });
            });
        };

        window.sendRequest = async (uid) => {
            await updateDoc(doc(db, "users", uid), {
                requests: arrayUnion(window.currentUser.uid)
            });
            alert("Request Sent!");
        };

        function listenForRequests() {
            onSnapshot(doc(db, "users", window.currentUser.uid), (doc) => {
                const requests = doc.data().requests || [];
                const dot = document.getElementById('requestDot');
                if (requests.length > 0) dot.classList.remove('hidden');
                else dot.classList.add('hidden');

                const list = document.getElementById('requestsList');
                list.innerHTML = "";
                requests.forEach(async (reqId) => {
                    // Fetch requester details (simplified)
                    list.innerHTML += `<div class="p-3 border-b">Request from User ID: ${reqId.substring(0,5)}... 
                    <button onclick="acceptRequest('${reqId}')" class="text-green-600 font-bold ml-2">Accept</button></div>`;
                });
            });
        }

        window.acceptRequest = async (friendId) => {
            const myRef = doc(db, "users", window.currentUser.uid);
            const friendRef = doc(db, "users", friendId);
            
            // Generate Chat ID
            const chatId = [window.currentUser.uid, friendId].sort().join("_");
            
            await updateDoc(myRef, { friends: arrayUnion(friendId), requests: [] }); // Clear reqs for demo
            await updateDoc(friendRef, { friends: arrayUnion(window.currentUser.uid) });
            
            // Create Chat Room
            await setDoc(doc(db, "chats", chatId), {
                participants: [window.currentUser.uid, friendId],
                isHidden: false,
                lastMessage: "",
                timestamp: serverTimestamp()
            });
            alert("Friend Added!");
            location.reload(); // Simple reload to refresh list
        };

        // --- CHAT SYSTEM ---
        function loadChats() {
            const q = query(collection(db, "chats"), where("participants", "array-contains", window.currentUser.uid), orderBy("timestamp", "desc"));
            onSnapshot(q, (snap) => {
                const list = document.getElementById('chatsListSection');
                list.innerHTML = "";
                snap.forEach(chat => {
                    const data = chat.data();
                    const otherId = data.participants.find(id => id !== window.currentUser.uid);
                    
                    // Private Mode Logic
                    if (data.isHidden && !window.privateMode) return; 

                    list.innerHTML += `
                    <div onclick="openChat('${chat.id}', '${otherId}')" class="flex items-center p-3 border-b bg-white cursor-pointer hover:bg-gray-50">
                        <div class="w-12 h-12 rounded-full bg-gray-300 mr-3 overflow-hidden">
                             <img src="https://ui-avatars.com/api/?name=User" class="w-full h-full object-cover">
                        </div>
                        <div class="flex-1">
                            <div class="flex justify-between">
                                <h4 class="font-bold text-gray-800">User ${otherId.substring(0,4)}</h4>
                                <span class="text-xs text-gray-500">Just now</span>
                            </div>
                            <p class="text-sm text-gray-500 truncate">${data.lastMessage || "Start chatting..."}</p>
                        </div>
                    </div>`;
                });
            });
        }

        window.openChat = (chatId, userId) => {
            window.currentChatId = chatId;
            document.getElementById('chatWindow').classList.remove('hidden');
            document.getElementById('chatUserName').innerText = "Friend"; // Simplify
            loadMessages(chatId);
        };

        window.closeChat = () => {
            document.getElementById('chatWindow').classList.add('hidden');
            window.currentChatId = null;
        };

        function loadMessages(chatId) {
            const q = query(collection(db, "chats", chatId, "messages"), orderBy("timestamp", "asc"));
            onSnapshot(q, (snap) => {
                const container = document.getElementById('messagesContainer');
                container.innerHTML = "";
                snap.forEach(doc => {
                    const msg = doc.data();
                    const isMe = msg.sender === window.currentUser.uid;
                    const align = isMe ? "self-end" : "self-start";
                    const color = isMe ? "bg-blue-100 chat-bubble-sent" : "bg-white";
                    
                    // Timestamp Logic for Edit (20 mins)
                    const msgTime = msg.timestamp ? msg.timestamp.toMillis() : Date.now();
                    const canEdit = isMe && (Date.now() - msgTime < 20 * 60 * 1000);
                    
                    container.innerHTML += `
                    <div oncontextmenu="openMsgOptions('${doc.id}', ${canEdit}); return false;" 
                         class="${align} ${color} p-2 px-4 rounded-lg shadow-sm max-w-[70%] mb-1 relative group">
                        <p>${msg.text}</p>
                        <span class="text-[10px] text-gray-400 flex justify-end gap-1">
                           ${new Date(msgTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                           ${isMe ? '<i class="fa-solid fa-check-double blue-tick"></i>' : ''}
                        </span>
                    </div>`;
                });
                container.scrollTop = container.scrollHeight; // Auto scroll to bottom
            });
        }

        window.sendMessage = async () => {
            const input = document.getElementById('msgInput');
            const text = input.value;
            if (!text || !window.currentChatId) return;

            await addDoc(collection(db, "chats", window.currentChatId, "messages"), {
                text: text,
                sender: window.currentUser.uid,
                timestamp: serverTimestamp(),
                seen: false
            });
            
            await updateDoc(doc(db, "chats", window.currentChatId), {
                lastMessage: text,
                timestamp: serverTimestamp()
            });
            input.value = "";
        };

        // --- PRIVATE MODE & EXTRAS ---
        window.togglePrivateMode = async () => {
            const icon = document.getElementById('modeIcon');
            const body = document.getElementById('mainBody');
            
            if (!window.privateMode) {
                // Activate Love Mode
                const pass = prompt("Enter Secret Password:");
                // In real app, check against DB. Here simple check:
                if (pass === "1234") { 
                    window.privateMode = true;
                    icon.classList.remove('fa-heart', 'fa-regular');
                    icon.classList.add('fa-heart', 'fa-solid', 'text-red-600');
                    body.classList.add('love-theme');
                    generateHearts();
                    loadChats(); // Reload to show hidden chats
                } else {
                    alert("Wrong Password!");
                }
            } else {
                // Deactivate
                window.privateMode = false;
                icon.classList.remove('fa-solid', 'text-red-600');
                icon.classList.add('fa-regular', 'text-gray-400');
                body.classList.remove('love-theme');
                document.getElementById('heartsContainer').innerHTML = ""; // Stop hearts
                loadChats(); // Hide hidden chats
            }
        };

        window.toggleHideChat = async () => {
            if(!window.currentChatId) return;
            const chatRef = doc(db, "chats", window.currentChatId);
            // Toggle current status
            const snap = await getDoc(chatRef);
            const currentStatus = snap.data().isHidden;
            await updateDoc(chatRef, { isHidden: !currentStatus });
            alert(currentStatus ? "Chat Unhidden!" : "Chat Hidden! Enable Private Mode to see.");
        };

        function generateHearts() {
            const container = document.getElementById('heartsContainer');
            setInterval(() => {
                if(!window.privateMode) return;
                const heart = document.createElement('div');
                heart.classList.add('heart');
                heart.innerHTML = '';
                heart.style.left = Math.random() * 100 + "vw";
                heart.style.animationDuration = Math.random() * 2 + 3 + "s";
                container.appendChild(heart);
                setTimeout(() => heart.remove(), 6000);
            }, 500);
        }

        // Call Simulation
        window.startCall = (type) => {
            const overlay = document.getElementById('callOverlay');
            overlay.classList.remove('hidden');
            document.getElementById('callUserName').innerText = type === 'video' ? "Video Calling..." : "Audio Calling...";
        };
        window.endCall = () => {
            document.getElementById('callOverlay').classList.add('hidden');
        };

        // Message Long Press (Simulated by right click or long tap context)
        window.openMsgOptions = (msgId, canEdit) => {
            window.selectedMsgId = msgId;
            const modal = document.getElementById('msgOptionsModal');
            modal.classList.remove('hidden');
            const editBtn = document.getElementById('editOption');
            if(!canEdit) editBtn.classList.add('hidden');
            else editBtn.classList.remove('hidden');
        };

    </script>
</body>
</html>
