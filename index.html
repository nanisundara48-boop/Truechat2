<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TrueChats Ultimate</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    
    <style>
        /* --- THEME & VARIABLES --- */
        :root {
            --primary: #6366f1; /* Modern Indigo */
            --primary-dark: #4f46e5;
            --bg: #0f172a; /* Deep Slate */
            --surface: #1e293b;
            --text: #f1f5f9;
            --text-sec: #94a3b8;
            --incoming: #334155;
            --outgoing: #6366f1;
            --danger: #ef4444;
            --success: #22c55e;
            --glass: rgba(30, 41, 59, 0.7);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text); height: 100dvh; overflow: hidden; display: flex; flex-direction: column; }
        
        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }

        /* --- UTILS --- */
        .hidden { display: none !important; }
        .flex { display: flex; align-items: center; }
        .center { display: flex; justify-content: center; align-items: center; }
        .col { flex-direction: column; }
        .btn-icon { background: none; border: none; color: var(--text); font-size: 1.2rem; cursor: pointer; padding: 8px; border-radius: 50%; transition: 0.2s; }
        .btn-icon:active { background: rgba(255,255,255,0.1); }

        /* --- SCREENS --- */
        .screen { position: fixed; inset: 0; width: 100%; height: 100%; z-index: 10; background: var(--bg); display: flex; flex-direction: column; }

        /* 1. INTRO ANIMATION */
        #intro-screen { z-index: 9999; background: var(--bg); }
        .logo-anim { font-size: 3rem; font-weight: 800; background: linear-gradient(to right, #6366f1, #a855f7); -webkit-background-clip: text; color: transparent; animation: pulse 2s infinite; }
        .nc-loader { width: 50px; height: 50px; border: 3px solid rgba(255,255,255,0.1); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; margin-top: 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* 2. AUTH SCREEN */
        .auth-card { background: var(--surface); padding: 2rem; border-radius: 24px; width: 90%; max-width: 400px; text-align: center; border: 1px solid rgba(255,255,255,0.05); box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); }
        .inp { width: 100%; padding: 14px; margin: 8px 0; background: #0f172a; border: 1px solid #334155; border-radius: 12px; color: white; outline: none; transition: 0.3s; }
        .inp:focus { border-color: var(--primary); }
        .btn-primary { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 12px; font-weight: 600; font-size: 1rem; cursor: pointer; margin-top: 10px; transition: 0.2s; }
        .btn-primary:active { transform: scale(0.98); }

        /* 3. MAIN APP LAYOUT */
        #app-screen { display: flex; flex-direction: row; }
        .sidebar { width: 380px; background: var(--surface); border-right: 1px solid #334155; display: flex; flex-direction: column; z-index: 5; }
        .chat-view { flex: 1; background: #0b1120; position: relative; display: flex; flex-direction: column; background-image: radial-gradient(#1e293b 1px, transparent 1px); background-size: 20px 20px; }

        /* SIDEBAR COMPONENTS */
        .header { padding: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #334155; background: rgba(30,41,59,0.8); backdrop-filter: blur(10px); }
        .avatar { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary); background: #334155; }
        .nav-tabs { display: flex; padding: 10px; gap: 10px; overflow-x: auto; }
        .tab { flex: 1; padding: 10px; border-radius: 10px; border: none; background: transparent; color: var(--text-sec); font-weight: 600; cursor: pointer; transition: 0.3s; white-space: nowrap; }
        .tab.active { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4); }

        /* LIST ITEMS */
        .list-container { flex: 1; overflow-y: auto; padding: 10px; }
        .item-card { display: flex; align-items: center; padding: 12px; border-radius: 16px; margin-bottom: 5px; cursor: pointer; transition: 0.2s; }
        .item-card:hover { background: rgba(255,255,255,0.05); }
        .item-info { flex: 1; margin-left: 15px; }
        .item-name { font-weight: 600; font-size: 1rem; }
        .item-sub { font-size: 0.85rem; color: var(--text-sec); margin-top: 2px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 200px; }

        /* CHAT AREA */
        .chat-header { padding: 10px 20px; background: rgba(30,41,59,0.9); backdrop-filter: blur(10px); display: flex; align-items: center; border-bottom: 1px solid #334155; height: 70px; }
        .messages-box { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 8px; }
        
        .msg { max-width: 75%; padding: 10px 16px; border-radius: 18px; font-size: 0.95rem; position: relative; word-wrap: break-word; line-height: 1.4; }
        .msg.sent { align-self: flex-end; background: var(--outgoing); color: white; border-bottom-right-radius: 4px; }
        .msg.received { align-self: flex-start; background: var(--incoming); color: var(--text); border-bottom-left-radius: 4px; }
        .msg.system { align-self: center; background: rgba(255,255,255,0.1); font-size: 0.75rem; padding: 5px 12px; border-radius: 20px; color: var(--text-sec); }

        .chat-input { padding: 10px 15px; background: var(--surface); display: flex; align-items: center; gap: 10px; }
        .chat-input input { flex: 1; padding: 12px 20px; background: #0f172a; border: 1px solid #334155; border-radius: 30px; color: white; outline: none; }

        /* CALL UI (Modern) */
        #call-modal { z-index: 5000; background: #000; }
        .video-container { position: relative; width: 100%; height: 100%; display: flex; justify-content: center; background: #111; }
        
        /* Remote Video (Full Screen) */
        #remote-video { width: 100%; height: 100%; object-fit: cover; }
        
        /* Local Video (PIP) */
        #local-video { position: absolute; bottom: 120px; right: 20px; width: 120px; height: 160px; object-fit: cover; border-radius: 12px; border: 2px solid rgba(255,255,255,0.2); box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 10; background: #222; transition: 0.3s; }
        
        /* Audio Only Mode Placeholder */
        .audio-placeholder { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; background: linear-gradient(180deg, #1e293b, #0f172a); z-index: 5; }
        .pulsing-avatar { width: 150px; height: 150px; border-radius: 50%; border: 4px solid var(--primary); animation: pulse-ring 2s infinite; object-fit: cover; }
        @keyframes pulse-ring { 0% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.7); } 70% { box-shadow: 0 0 0 30px rgba(99, 102, 241, 0); } 100% { box-shadow: 0 0 0 0 rgba(0, 0, 0, 0); } }

        .call-controls { position: absolute; bottom: 30px; left: 0; width: 100%; display: flex; justify-content: center; gap: 20px; z-index: 20; }
        .call-btn { width: 60px; height: 60px; border-radius: 50%; border: none; font-size: 1.5rem; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); box-shadow: 0 8px 20px rgba(0,0,0,0.3); transition: 0.3s; }
        .btn-red { background: var(--danger); }
        .btn-green { background: var(--success); }
        .btn-glass { background: rgba(255,255,255,0.2); }
        .btn-glass:hover { background: rgba(255,255,255,0.3); }

        /* CHAT LOCK MODAL */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 4000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        
        /* MOBILE RESPONSIVE */
        @media (max-width: 768px) {
            .sidebar { width: 100%; height: 100%; }
            .chat-view { position: fixed; inset: 0; transform: translateX(100%); transition: 0.3s ease; z-index: 20; }
            .chat-view.active { transform: translateX(0); }
            .back-arrow { display: block !important; }
        }
        .back-arrow { display: none; font-size: 1.5rem; margin-right: 15px; cursor: pointer; }

    </style>
</head>
<body>

    <div id="intro-screen" class="screen center">
        <div class="logo-anim">TrueChats X</div>
        <div class="nc-loader"></div>
        <p style="margin-top: 15px; color: var(--text-sec); letter-spacing: 1px;">ULTIMATE</p>
    </div>

    <audio id="ring-out" src="https://assets.mixkit.co/active_storage/sfx/1359/1359-preview.mp3" loop></audio>
    <audio id="ring-in" src="https://assets.mixkit.co/active_storage/sfx/2346/2346-preview.mp3" loop></audio>

    <div id="auth-screen" class="screen center hidden">
        <div class="auth-card">
            <h2 style="margin-bottom: 20px;">Welcome</h2>
            <input type="email" id="email" class="inp" placeholder="Email Address">
            <input type="password" id="password" class="inp" placeholder="Password">
            <button onclick="handleAuth('login')" class="btn-primary">Login</button>
            <button onclick="handleAuth('register')" class="btn-primary" style="background: var(--surface); border:1px solid #334155;">Create Account</button>
        </div>
    </div>

    <div id="app-screen" class="hidden" style="width:100%; height:100%;">
        
        <div class="sidebar">
            <div class="header">
                <div class="flex" style="gap:12px;">
                    <img id="my-dp" class="avatar" src="" onclick="changeDP()" onerror="this.src='https://ui-avatars.com/api/?background=random&color=fff'">
                    <div>
                        <h4 id="my-name">User</h4>
                        <span style="font-size: 0.75rem; color: var(--success);">‚óè Online</span>
                    </div>
                </div>
                <div class="flex">
                    <button class="btn-icon" onclick="logout()"><i class="ri-logout-box-r-line"></i></button>
                </div>
            </div>

            <div class="nav-tabs">
                <button class="tab active" onclick="switchTab('chats', this)">Chats</button>
                <button class="tab" onclick="switchTab('calls', this)">Calls</button>
                <button class="tab" onclick="switchTab('search', this)">Search</button>
                <button class="tab" onclick="switchTab('requests', this)">Requests</button>
            </div>

            <div id="tab-chats" class="list-container"></div>
            <div id="tab-calls" class="list-container hidden"></div>
            <div id="tab-search" class="list-container hidden">
                <input type="text" class="inp" placeholder="Search by email..." onkeyup="searchUser(this.value)">
                <div id="search-results"></div>
            </div>
            <div id="tab-requests" class="list-container hidden"></div>
        </div>

        <div id="chat-view" class="chat-view">
            <div id="empty-state" class="center col" style="height:100%; color: var(--text-sec);">
                <i class="ri-chat-smile-2-line" style="font-size: 4rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                <p>Select a conversation</p>
            </div>

            <div id="active-chat" class="hidden" style="height: 100%; display: flex; flex-direction: column;">
                <div class="chat-header">
                    <i class="ri-arrow-left-line back-arrow" onclick="closeChat()"></i>
                    <img id="chat-dp" class="avatar" src="">
                    <div style="flex:1; margin-left: 12px; cursor: pointer;" onclick="toggleChatLock()">
                        <h4 id="chat-name">User</h4>
                        <span style="font-size: 0.75rem; color: var(--text-sec);" id="chat-lock-status">Click to Lock</span>
                    </div>
                    <div class="flex" style="gap: 15px;">
                        <button class="btn-icon" onclick="initiateCall('audio')"><i class="ri-phone-line"></i></button>
                        <button class="btn-icon" onclick="initiateCall('video')"><i class="ri-vidicon-line"></i></button>
                    </div>
                </div>

                <div id="messages-box" class="messages-box"></div>

                <div class="chat-input">
                    <button class="btn-icon"><i class="ri-add-circle-line"></i></button>
                    <input type="text" id="msg-input" placeholder="Type a message...">
                    <button class="btn-icon" style="background: var(--primary); color: white;" onclick="sendMessage()"><i class="ri-send-plane-fill"></i></button>
                </div>
            </div>
        </div>
    </div>

    <div id="call-modal" class="screen hidden">
        <div class="video-container">
            <video id="remote-video" autoplay playsinline></video>
            
            <video id="local-video" autoplay playsinline muted></video>

            <div id="audio-ui" class="audio-placeholder hidden">
                <img id="call-avatar" class="pulsing-avatar" src="">
                <h2 id="call-name" style="margin-top: 20px;">User</h2>
                <p id="call-status-text" style="color: var(--text-sec); margin-top: 10px;">Connecting...</p>
                <p id="call-timer" style="margin-top: 10px; font-weight: bold; font-family: monospace;">00:00</p>
            </div>

            <div class="call-controls">
                <div id="incoming-actions" class="flex gap-4 hidden">
                    <button class="call-btn btn-red" onclick="rejectCall()"><i class="ri-phone-close-line"></i></button>
                    <button class="call-btn btn-green" onclick="answerCall()"><i class="ri-phone-answer-line"></i></button>
                </div>
                
                <div id="active-actions" class="flex gap-4">
                    <button class="call-btn btn-glass" onclick="toggleMute()"><i class="ri-mic-line" id="mic-icon"></i></button>
                    <button class="call-btn btn-glass" onclick="toggleVideo()"><i class="ri-camera-line" id="cam-icon"></i></button>
                    <button class="call-btn btn-red" onclick="endCall()"><i class="ri-phone-close-line"></i></button>
                </div>
            </div>
        </div>
    </div>

    <div id="lock-modal" class="modal-overlay">
        <div class="auth-card">
            <h3>Enter PIN</h3>
            <p style="color: var(--text-sec); font-size: 0.8rem; margin-bottom: 10px;">Default: 0000</p>
            <input type="password" id="lock-pin" class="inp" style="text-align: center; font-size: 1.5rem; letter-spacing: 5px;" maxlength="4">
            <button class="btn-primary" onclick="checkPin()">Unlock</button>
            <button class="btn-primary" style="background: transparent; margin-top: 5px;" onclick="document.getElementById('lock-modal').style.display='none'">Cancel</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, serverTimestamp, updateDoc, doc, setDoc, getDoc, getDocs, orderBy, arrayUnion, arrayRemove, limit } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";

        // FIREBASE CONFIG
        const config={apiKey:"AIzaSyCAsCm1YcsAjHwyvIzxyMrBmZPLw2hlo18",authDomain:"truechats-8dac9.firebaseapp.com",projectId:"truechats-8dac9",storageBucket:"truechats-8dac9.firebasestorage.app",messagingSenderId:"685374771914",appId:"1:685374771914:web:81bf491264c1bb09061a33"};
        const app=initializeApp(config); const auth=getAuth(app); const db=getFirestore(app); const storage=getStorage(app);

        // STATE
        let currentUser, currentChatUser, chatId, peer, localStream, activeCall, callDocId;
        let ringTimeout, callDurationInterval;
        let lockedChats = JSON.parse(localStorage.getItem('lockedChats') || "[]");

        // --- AUTH & INIT ---
        onAuthStateChanged(auth, async (u) => {
            const intro = document.getElementById('intro-screen');
            if(u) {
                currentUser = u;
                setTimeout(() => { intro.style.display = 'none'; }, 1500);
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app-screen').classList.remove('hidden');
                
                document.getElementById('my-name').innerText = u.displayName || "User";
                document.getElementById('my-dp').src = u.photoURL || `https://ui-avatars.com/api/?name=${u.email}&background=random`;
                
                await setDoc(doc(db, "users", u.uid), {
                    uid: u.uid, email: u.email.toLowerCase(), 
                    displayName: u.displayName || u.email.split('@')[0], 
                    photoURL: u.photoURL
                }, { merge: true });

                initPeer(); loadChats(); loadCalls();
            } else {
                intro.style.display = 'none';
                document.getElementById('auth-screen').classList.remove('hidden');
            }
        });

        window.handleAuth = async (type) => {
            const e = document.getElementById('email').value;
            const p = document.getElementById('password').value;
            try {
                if(type === 'login') await signInWithEmailAndPassword(auth, e, p);
                else {
                    const res = await createUserWithEmailAndPassword(auth, e, p);
                    await updateProfile(res.user, { displayName: e.split('@')[0] });
                }
            } catch(err) { alert(err.message); }
        };
        window.logout = () => signOut(auth);

        // --- CHAT ENGINE ---
        window.openChat = async (uid) => {
            const uDoc = await getDoc(doc(db, "users", uid));
            currentChatUser = uDoc.data();
            
            // Check Lock
            if(lockedChats.includes(currentChatUser.email)) {
                document.getElementById('lock-modal').style.display = 'flex';
                return; 
            }
            loadChatUI();
        };

        window.checkPin = () => {
            const pin = document.getElementById('lock-pin').value;
            if(pin === "0000") {
                document.getElementById('lock-modal').style.display = 'none';
                loadChatUI();
            } else { alert("Wrong PIN"); }
            document.getElementById('lock-pin').value = "";
        };

        function loadChatUI() {
            chatId = [currentUser.uid, currentChatUser.uid].sort().join("_");
            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('active-chat').classList.remove('hidden');
            document.getElementById('chat-view').classList.add('active'); // Mobile slide
            
            document.getElementById('chat-name').innerText = currentChatUser.displayName;
            document.getElementById('chat-dp').src = currentChatUser.photoURL || `https://ui-avatars.com/api/?name=${currentChatUser.displayName}`;
            document.getElementById('chat-lock-status').innerText = lockedChats.includes(currentChatUser.email) ? "Locked üîí" : "Unlocked üîì";
            
            loadMessages();
        }

        window.closeChat = () => {
            document.getElementById('chat-view').classList.remove('active');
        };

        function loadMessages() {
            const box = document.getElementById('messages-box');
            const q = query(collection(db, "messages"), where("chatId", "==", chatId), orderBy("createdAt", "asc"));
            onSnapshot(q, (snap) => {
                box.innerHTML = "";
                snap.forEach(d => {
                    const data = d.data();
                    const div = document.createElement('div');
                    if(data.type === 'system') {
                        div.className = 'msg system';
                        div.innerText = data.text;
                    } else {
                        div.className = `msg ${data.sender === currentUser.uid ? 'sent' : 'received'}`;
                        div.innerText = data.text;
                    }
                    box.appendChild(div);
                });
                box.scrollTop = box.scrollHeight;
            });
        }

        window.sendMessage = async () => {
            const txt = document.getElementById('msg-input').value;
            if(!txt) return;
            await addDoc(collection(db, "messages"), {
                text: txt, sender: currentUser.uid, chatId, createdAt: serverTimestamp(), type: 'text'
            });
            document.getElementById('msg-input').value = "";
        };

        window.toggleChatLock = () => {
            const email = currentChatUser.email;
            if(lockedChats.includes(email)) {
                lockedChats = lockedChats.filter(e => e !== email);
            } else {
                lockedChats.push(email);
            }
            localStorage.setItem('lockedChats', JSON.stringify(lockedChats));
            document.getElementById('chat-lock-status').innerText = lockedChats.includes(email) ? "Locked üîí" : "Unlocked üîì";
        };

        // --- CALLING LOGIC (THE BIG UPDATE) ---
        function initPeer() {
            peer = new Peer(currentUser.uid);
            
            // INCOMING CALL
            peer.on('call', (call) => {
                activeCall = call;
                // Fetch caller info
                getDoc(doc(db, "users", call.peer)).then(snap => {
                    const caller = snap.data();
                    showCallScreen(caller, false, call.metadata.type); // type: video/audio
                    
                    // Play Ringtone
                    document.getElementById('ring-in').play();
                    
                    // Listen for remote hangup (Firestore sync)
                    const unsub = onSnapshot(collection(db, "calls"), (snap) => {
                        snap.docChanges().forEach(change => {
                            const d = change.doc.data();
                            // If this call doc relates to us and says "ended"
                            if(d.to === currentUser.uid && d.status === 'ended' && change.type === 'added') {
                                cleanupCallUI();
                            }
                        });
                    });
                });
            });
        }

        window.initiateCall = async (type) => {
             // 1. UI Setup
            showCallScreen(currentChatUser, true, type);
            
            // 2. Play Ringtone
            document.getElementById('ring-out').play();
            
            // 3. Firestore Signal (Intent to Call)
            const callRef = await addDoc(collection(db, "calls"), {
                from: currentUser.uid, to: currentChatUser.uid, 
                status: 'ringing', type, createdAt: serverTimestamp()
            });
            callDocId = callRef.id;

            // 4. Timer 84 Seconds (1m 24s)
            ringTimeout = setTimeout(() => {
                endCall("No Answer");
            }, 84000);

            // 5. Get Stream & Connect
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: type==='video', audio: true });
                if(type === 'video') document.getElementById('local-video').srcObject = localStream;
                
                const call = peer.call(currentChatUser.uid, localStream, { metadata: { type } });
                activeCall = call;

                call.on('stream', (remoteStream) => {
                    handleRemoteStream(remoteStream, type);
                });
                
                // Watch for rejection
                onSnapshot(doc(db, "calls", callDocId), (snap) => {
                    const d = snap.data();
                    if(d && d.status === 'rejected') endCall("Busy");
                    if(d && d.status === 'connected') {
                        document.getElementById('ring-out').pause();
                        clearTimeout(ringTimeout);
                        startCallTimer();
                        document.getElementById('call-status-text').innerText = "Connected";
                    }
                });

            } catch(e) { 
                alert("Permission Denied: " + e.message); 
                cleanupCallUI();
            }
        };

        window.answerCall = async () => {
            document.getElementById('ring-in').pause();
            const type = document.getElementById('remote-video').classList.contains('hidden') ? 'audio' : 'video'; // crude check
            
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true }); // Default to video capable
                activeCall.answer(localStream);
                
                // Update Firestore
                // NOTE: In a real app we'd need the callDocId from the caller. 
                // For simplicity, we assume the peer connection is the main driver here.
                
                document.getElementById('incoming-actions').classList.add('hidden');
                document.getElementById('active-actions').classList.remove('hidden');
                document.getElementById('call-status-text').innerText = "Connected";
                startCallTimer();

                activeCall.on('stream', (rs) => {
                    document.getElementById('remote-video').srcObject = rs;
                    if(type === 'video') {
                        document.getElementById('local-video').srcObject = localStream;
                    }
                });
                
                // Log Call
                logCall(activeCall.peer, 'incoming', type);

            } catch(e) { alert(e.message); cleanupCallUI(); }
        };

        window.rejectCall = () => {
            document.getElementById('ring-in').pause();
            // Signal rejection (Simplified: just close Peer)
            if(activeCall) activeCall.close();
            cleanupCallUI();
        };

        window.endCall = async (reason = "Call Ended") => {
            // Update Firestore to notify peer
            if(callDocId) {
                updateDoc(doc(db, "calls", callDocId), { status: 'ended' });
            }
            if(activeCall) activeCall.close();
            
            // Log for Sender
            if(currentChatUser)
    logCall(currentChatUser.uid, 'outgoing', 'video'); // type assumption
            
            // System Msg in Chat
            if(chatId) {
                addDoc(collection(db, "messages"), {
                    text: `üìû ${reason}`, sender: currentUser.uid, chatId, type: 'system', createdAt: serverTimestamp()
                });
            }

            cleanupCallUI();
        };

        function showCallScreen(user, isOutgoing, type) {
            document.getElementById('call-modal').classList.remove('hidden');
            document.getElementById('call-avatar').src = user.photoURL || `https://ui-avatars.com/api/?name=${user.displayName}`;
            document.getElementById('call-name').innerText = user.displayName;
            
            // Reset UI
            document.getElementById('remote-video').srcObject = null;
            document.getElementById('local-video').srcObject = null;
            
            if(type === 'audio') {
                document.getElementById('audio-ui').classList.remove('hidden');
                document.getElementById('remote-video').classList.add('hidden');
                document.getElementById('local-video').classList.add('hidden');
            } else {
                document.getElementById('audio-ui').classList.add('hidden');
                document.getElementById('remote-video').classList.remove('hidden');
                document.getElementById('local-video').classList.remove('hidden');
            }

            if(isOutgoing) {
                document.getElementById('incoming-actions').classList.add('hidden');
                document.getElementById('active-actions').classList.remove('hidden');
                document.getElementById('call-status-text').innerText = "Ringing...";
            } else {
                document.getElementById('incoming-actions').classList.remove('hidden');
                document.getElementById('active-actions').classList.add('hidden');
                document.getElementById('call-status-text').innerText = "Incoming Call...";
            }
        }

        function handleRemoteStream(stream, type) {
            document.getElementById('ring-out').pause();
            clearTimeout(ringTimeout);
            document.getElementById('call-status-text').innerText = "Connected";
            
            if(type === 'video') {
                document.getElementById('remote-video').srcObject = stream;
            } else {
                const aud = new Audio();
                aud.srcObject = stream;
                aud.play();
            }
        }

        function cleanupCallUI() {
            document.getElementById('call-modal').classList.add('hidden');
            document.getElementById('ring-out').pause();
            document.getElementById('ring-in').pause();
            document.getElementById('ring-out').currentTime = 0;
            document.getElementById('ring-in').currentTime = 0;
            if(localStream) localStream.getTracks().forEach(t => t.stop());
            clearInterval(callDurationInterval);
            document.getElementById('call-timer').innerText = "00:00";
        }

        function startCallTimer() {
            let sec = 0;
            clearInterval(callDurationInterval);
            callDurationInterval = setInterval(() => {
                sec++;
                const m = Math.floor(sec / 60).toString().padStart(2, '0');
                const s = (sec % 60).toString().padStart(2, '0');
                document.getElementById('call-timer').innerText = `${m}:${s}`;
            }, 1000);
        }

        // --- CALL HISTORY (48 HOURS) ---
        async function logCall(uid, dir, type) {
            const now = new Date();
            const expires = new Date(now.getTime() + (48 * 60 * 60 * 1000));
            
            await addDoc(collection(db, "callLogs"), {
                userId: currentUser.uid, peerId: uid, direction: dir, type,
                timestamp: serverTimestamp(), expiresAt: expires.toISOString()
            });
        }

        function loadCalls() {
            const q = query(collection(db, "callLogs"), where("userId", "==", currentUser.uid), orderBy("timestamp", "desc"));
            onSnapshot(q, async (snap) => {
                const list = document.getElementById('tab-calls');
                list.innerHTML = "";
                const now = new Date();
                
                for(const d of snap.docs) {
                    const data = d.data();
                    if(new Date(data.expiresAt) > now) {
                        const uDoc = await getDoc(doc(db, "users", data.peerId));
                        const u = uDoc.data();
                        
                        const time = data.timestamp ? data.timestamp.toDate().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : 'Just now';
                        const icon = data.direction === 'outgoing' ? '<i class="ri-arrow-right-up-line" style="color:var(--success)"></i>' : '<i class="ri-arrow-left-down-line" style="color:var(--danger)"></i>';
                        
                        list.innerHTML += `
                        <div class="item-card">
                            <img src="${u.photoURL || 'https://ui-avatars.com/api/?name='+u.displayName}" class="avatar">
                            <div class="item-info">
                                <div class="item-name">${u.displayName}</div>
                                <div class="item-sub">${icon} ${time}</div>
                            </div>
                            <i class="ri-${data.type === 'video' ? 'vidicon' : 'phone'}-line"></i>
                        </div>`;
                    }
                }
            });
        }

        // --- TABS & HELPERS ---
                window.switchTab = (t, el) => {
            document.querySelectorAll('.list-container').forEach(e => e.classList.add('hidden'));
            document.getElementById(`tab-${t}`).classList.remove('hidden');
            document.querySelectorAll('.tab').forEach(e => e.classList.remove('active'));
            el.classList.add('active');
        };

        function loadChats() {
            // Simplified friend loader (Existing logic adapted)
            const q = query(collection(db, "users"), where("friends", "array-contains", currentUser.uid));
            onSnapshot(doc(db, "users", currentUser.uid), async (snap) => {
                const list = document.getElementById('tab-chats');
                list.innerHTML = "";
                const friends = snap.data().friends || [];
                
                for(const fid of friends) {
                    const fDoc = await getDoc(doc(db, "users", fid));
                    const f = fDoc.data();
                    list.innerHTML += `
                    <div class="item-card" onclick="openChat('${f.uid}')">
                        <img src="${f.photoURL || 'https://ui-avatars.com/api/?name='+f.displayName}" class="avatar" onerror="this.src='https://ui-avatars.com/api/?background=random'">
                        <div class="item-info">
                            <div class="item-name">${f.displayName}</div>
                            <div class="item-sub">Tap to chat</div>
                        </div>
                    </div>`;
                }
            });
        }
        
        // Search & Requests (Keeping existing functionality simple)
        window.searchUser = async (val) => {
            if(val.length < 3) return;
            const q = query(collection(db, "users"), where("email", ">=", val), where("email", "<=", val+'\uf8ff'));
            const snap = await getDocs(q);
            const res = document.getElementById('search-results');
            res.innerHTML = "";
            snap.forEach(d => {
                const u = d.data();
                if(u.uid !== currentUser.uid) {
                    res.innerHTML += `<div class="item-card"><div class="item-name">${u.email}</div> <button onclick="sendReq('${u.uid}')" style="margin-left:auto; padding:5px 10px;">Add</button></div>`;
                }
            });
        };
        window.sendReq = async (uid) => { await updateDoc(doc(db, "users", uid), { requests: arrayUnion(currentUser.uid) }); alert("Sent"); };

        window.toggleMute = () => {
            const track = localStream.getAudioTracks()[0];
            track.enabled = !track.enabled;
            document.getElementById('mic-icon').className = track.enabled ? 'ri-mic-line' : 'ri-mic-off-line';
        };
        window.toggleVideo = () => {
            const track = localStream.getVideoTracks()[0];
            track.enabled = !track.enabled;
            document.getElementById('cam-icon').className = track.enabled ? 'ri-camera-line' : 'ri-camera-off-line';
        };
        window.changeDP = () => {
            const input = document.createElement('input'); input.type = 'file';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                const refS = ref(storage, `dp/${currentUser.uid}`);
                await uploadBytes(refS, file);
                const url = await getDownloadURL(refS);
                await updateProfile(currentUser, { photoURL: url });
                await updateDoc(doc(db, "users", currentUser.uid), { photoURL: url });
            };
            input.click();
        };

    </script>
</body>
</html>
