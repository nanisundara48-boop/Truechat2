<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TrueChats Sensory</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    
    <style>
        /* --- THEMES --- */
        :root {
            --primary: #008069; --bg-grad: linear-gradient(135deg, #008069, #00a884);
            --chat-bg: #efeae2; --sent: #d9fdd3; --received: #fff; --text: #111;
        }
        body.theme-ocean { --primary: #0084ff; --bg-grad: linear-gradient(135deg, #00c6ff, #0072ff); --chat-bg: #f0f8ff; --sent: #cce4ff; }
        body.theme-night { --primary: #8e44ad; --bg-grad: #111; --chat-bg: #0b141a; --sent: #005c4b; --received: #202c33; --text: #fff; color: white; }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Outfit', sans-serif; }
        body { height: 100dvh; overflow: hidden; background: #d1d7db; transition: 0.3s; }
        .hidden { display: none !important; } 
        .center { display: flex; justify-content: center; align-items: center; }

        /* AUTH */
        #auth-screen { position: fixed; width: 100%; height: 100%; background: var(--bg-grad); z-index: 2000; flex-direction: column; }
        .card { background: rgba(255,255,255,0.9); padding: 30px; border-radius: 20px; width: 90%; max-width: 350px; text-align: center; backdrop-filter: blur(10px); box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        body.theme-night .card { background: #222; color: white; }
        input { width: 100%; padding: 15px; margin-bottom: 10px; border: none; background: #f0f2f5; border-radius: 10px; outline: none; }
        .btn { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; }

        /* APP LAYOUT */
        #app-screen { display: flex; height: 100%; width: 100%; background: white; }
        body.theme-night #app-screen { background: #111; }
        
        .sidebar { width: 350px; display: flex; flex-direction: column; border-right: 1px solid #ddd; z-index: 10; background: inherit; }
        
        .header { padding: 15px; background: var(--bg-grad); display: flex; align-items: center; justify-content: space-between; color: white; }
        .my-dp { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 2px solid white; cursor: pointer; }

        .tabs { display: flex; background: rgba(0,0,0,0.05); padding: 5px; }
        .tab-btn { flex: 1; padding: 10px; border: none; background: transparent; cursor: pointer; color: #888; border-radius: 5px; }
        .tab-btn.active { background: var(--primary); color: white; }

        .list-area { flex: 1; overflow-y: auto; padding: 10px; }
        .item { display: flex; align-items: center; padding: 12px; margin-bottom: 5px; border-radius: 10px; cursor: pointer; }
        .item:hover { background: rgba(0,0,0,0.05); }
        .item img { width: 45px; height: 45px; border-radius: 50%; margin-right: 15px; object-fit: cover; }

        /* CHAT AREA */
        .chat-area { flex: 1; display: flex; flex-direction: column; background: var(--chat-bg); position: relative; }
        .chat-area::before { content: ""; position: absolute; width: 100%; height: 100%; opacity: 0.06; background-image: url("https://www.transparenttextures.com/patterns/cubes.png"); pointer-events: none; }

        .chat-header { background: var(--bg-grad); padding: 10px 15px; display: flex; align-items: center; height: 60px; color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .chat-header img { width: 40px; height: 40px; border-radius: 50%; margin: 0 10px; border: 2px solid white; object-fit: cover; }
        
        #messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; z-index: 1; }
        .msg { max-width: 75%; padding: 8px 14px; border-radius: 14px; font-size: 14.5px; position: relative; word-wrap: break-word; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .sent { align-self: flex-end; background: var(--sent); color: #111; border-bottom-right-radius: 0; }
        .received { align-self: flex-start; background: var(--received); color: var(--text); border-bottom-left-radius: 0; }
        
        .tick { font-size: 11px; float: right; margin-top: 5px; margin-left: 5px; }
        .seen { color: #34b7f1; } 

        .input-bar { padding: 10px; background: inherit; display: flex; align-items: center; gap: 10px; border-top: 1px solid #ddd; }
        .input-bar input { flex: 1; padding: 12px 20px; background: rgba(0,0,0,0.05); border: none; border-radius: 30px; outline: none; color: inherit; }

        /* CALL OVERLAY */
        #call-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0f172a; z-index: 5000; flex-direction: column; color: white; }
        #call-avatar { width: 140px; height: 140px; border-radius: 50%; border: 4px solid rgba(255,255,255,0.2); margin-bottom: 20px; animation: pulse 1.5s infinite; object-fit: cover; }
        .c-btn { width: 65px; height: 65px; border-radius: 50%; border: none; font-size: 24px; cursor: pointer; display: flex; justify-content: center; align-items: center; color: white; transition: 0.3s; }
        .bg-red { background: #ff4757; } .bg-green { background: #2ecc71; } .bg-grey { background: #334155; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255,255,255,0.4); } 70% { box-shadow: 0 0 0 30px rgba(0,0,0,0); } }

        /* MODALS (Settings/About) */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 3000; }
        .modal-box { background: white; width: 85%; max-width: 300px; padding: 20px; border-radius: 15px; color: #333; }
        body.theme-night .modal-box { background: #222; color: white; }
        .opt-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; }
        
        /* MOBILE */
        @media (max-width: 768px) {
            .sidebar { width: 100%; height: 100%; }
            .chat-area { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 50; transform: translateX(100%); transition: 0.3s; }
            .chat-area.active { transform: translateX(0); }
            .back-btn { display: block !important; }
        }
        .back-btn { display: none; cursor: pointer; margin-right: 15px; font-size: 18px; }
    </style>
</head>
<body>

    <div id="settings-modal" class="modal-overlay hidden center" onclick="toggleSettings()">
        <div class="modal-box" onclick="event.stopPropagation()">
            <h3>Settings</h3>
            <br>
            <div class="opt-row">
                <span>Theme</span>
                <select id="theme-select" onchange="changeTheme(this.value)" style="padding:5px;">
                    <option value="default">Emerald</option>
                    <option value="ocean">Ocean Blue</option>
                    <option value="night">Night Mode</option>
                </select>
            </div>
            <div class="opt-row">
                <span>Auto-Delete</span>
                <select id="delete-timer" style="padding:5px;">
                    <option value="24">24 Hours</option>
                    <option value="48" selected>48 Hours</option>
                </select>
            </div>
            <div class="opt-row">
                <span>Nickname</span>
                <button onclick="changeName()" style="padding:5px 10px; background:var(--primary); color:white; border:none; border-radius:5px;">Edit</button>
            </div>
        </div>
    </div>

    <div id="about-modal" class="modal-overlay hidden center" onclick="toggleAbout()">
        <div class="modal-box center" style="flex-direction:column;" onclick="event.stopPropagation()">
            <img id="about-img" src="" style="width:80px; height:80px; border-radius:50%; margin-bottom:10px;">
            <h2 id="about-name">User</h2>
            <p id="about-email" style="color:gray; font-size:14px; margin-bottom:15px;">email@example.com</p>
            <button onclick="toggleAbout()" style="padding:8px 20px; background:var(--primary); color:white; border:none; border-radius:5px;">Close</button>
        </div>
    </div>

    <div id="call-screen" class="center hidden">
        <img id="call-avatar" src="">
        <h2 id="call-user">User</h2>
        <p id="call-status">Calling...</p>
        
        <div id="inc-btns" class="hidden center" style="gap:30px; margin-top:50px;">
            <button class="c-btn bg-red" onclick="rejectCall()"><i class="fa fa-phone-slash"></i></button>
            <button class="c-btn bg-green" onclick="answerCall()"><i class="fa fa-phone"></i></button>
        </div>
        
        <div id="ong-btns" class="center hidden" style="gap:20px; margin-top:50px;">
            <button class="c-btn bg-grey" onclick="toggleSpeaker()"><i class="fa fa-volume-up"></i></button>
            <button class="c-btn bg-grey" onclick="toggleMute()"><i class="fa fa-microphone"></i></button>
            <button class="c-btn bg-red" onclick="endCall()"><i class="fa fa-phone-slash"></i></button>
        </div>
    </div>

    <div id="app-screen" class="hidden">
        <div class="sidebar">
            <div class="header">
                <div class="center" style="gap:10px;">
                    <img id="my-dp" class="my-dp" src="" onclick="changeDP()">
                    <h3 id="my-name">Me</h3>
                </div>
                <div class="center" style="gap:15px;">
                    <i class="fa fa-cog" onclick="toggleSettings()" style="cursor:pointer;" title="Settings"></i>
                    <i class="fa fa-power-off" onclick="logout()" style="cursor:pointer;" title="Logout"></i>
                </div>
            </div>

            <div class="tabs">
                <button onclick="switchTab('friends', this)" class="tab-btn active">Chats</button>
                <button onclick="switchTab('search', this)" class="tab-btn">Search</button>
                <button onclick="switchTab('requests', this)" class="tab-btn">Requests <span id="req-cnt">0</span></button>
            </div>

            <div id="tab-friends" class="list-area">Loading...</div>
            <div id="tab-search" class="list-area hidden"><input type="text" placeholder="Search..." onkeyup="searchUsers(this)" style="width:100%; padding:10px; border-radius:10px; border:1px solid #ccc; margin-bottom:10px;"><div id="search-res"></div></div>
            <div id="tab-requests" class="list-area hidden"></div>
        </div>

        <div id="chat-area" class="chat-area">
            <div id="chat-header" class="chat-header hidden">
                <i class="fa fa-arrow-left back-btn" onclick="closeChat()"></i>
                <img id="chat-img" src="">
                <div style="flex:1; margin-left:10px;">
                    <h3 id="chat-name" style="font-size:16px;">User</h3>
                    <small>Online</small>
                </div>
                <i class="fa fa-info-circle" onclick="toggleAbout()" style="font-size:20px; cursor:pointer; margin-right:15px;" title="About User"></i>
                <i class="fa fa-phone" onclick="startCallUI()" style="font-size:20px; cursor:pointer;"></i>
            </div>
            
            <div id="messages"></div>

            <div id="input-bar" class="input-bar hidden">
                <input type="text" id="msg-input" placeholder="Message...">
                <button onclick="sendMessage()" style="width:40px; height:40px; border-radius:50%; background:var(--primary); color:white; border:none;"><i class="fa fa-paper-plane"></i></button>
            </div>
            
            <div id="empty-state" class="center" style="height:100%; flex-direction:column; color:#999;">
                <i class="fa fa-comments" style="font-size:60px; margin-bottom:15px; opacity:0.5"></i>
                <p>Select a chat</p>
            </div>
        </div>
    </div>

    <div id="auth-screen" class="center">
        <div class="card">
            <h1>TrueChats ðŸ”Š</h1>
            <p>Sensory Edition</p>
            <input type="email" id="email" placeholder="Email">
            <input type="password" id="password" placeholder="Password">
            <button onclick="login()" class="btn">Login</button>
            <button onclick="register()" class="btn" style="background:#555;">Register</button>
        </div>
    </div>

    <audio id="remote-audio" autoplay></audio>
    <audio id="ringtone" loop src="https://assets.mixkit.co/active_storage/sfx/1359/1359-preview.mp3"></audio>
    <audio id="connect-tone" src="https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.mp3"></audio>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, serverTimestamp, updateDoc, doc, setDoc, getDoc, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";

        const config={apiKey:"AIzaSyCAsCm1YcsAjHwyvIzxyMrBmZPLw2hlo18",authDomain:"truechats-8dac9.firebaseapp.com",projectId:"truechats-8dac9",storageBucket:"truechats-8dac9.firebasestorage.app",messagingSenderId:"685374771914",appId:"1:685374771914:web:81bf491264c1bb09061a33"};
        const app=initializeApp(config); const auth=getAuth(app); const db=getFirestore(app); const storage=getStorage(app);

        let currentUser, currentChatUser, chatId, peer, activeCall, localStream;
        const getAvatar=(u)=>u.photoURL||`https://ui-avatars.com/api/?name=${u.displayName}&background=random&color=fff`;

        // AUTH
        onAuthStateChanged(auth, async(u)=>{
            if(u){
                currentUser=u;
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app-screen').classList.remove('hidden');
                document.getElementById('my-name').innerText = u.displayName;
                document.getElementById('my-dp').src = getAvatar(u);
                await setDoc(doc(db,"users",u.uid),{uid:u.uid,email:u.email.toLowerCase(),displayName:u.displayName,photoURL:u.photoURL},{merge:true});
                initPeer(u.uid); loadFriends(); loadRequests();
            } else {
                document.getElementById('auth-screen').classList.remove('hidden');
                document.getElementById('app-screen').classList.add('hidden');
            }
        });

        // SETTINGS & NICKNAME
        window.toggleSettings = () => document.getElementById('settings-modal').classList.toggle('hidden');
        window.changeTheme = (t) => {
            document.body.className = t === 'default' ? '' : `theme-${t}`;
            toggleSettings();
        };
        window.changeName = async () => {
            const n = prompt("New Nickname:", currentUser.displayName);
            if(n){
                await updateProfile(currentUser, {displayName:n});
                await updateDoc(doc(db,"users",currentUser.uid),{displayName:n});
                document.getElementById('my-name').innerText=n;
            }
        };

        // CHAT
        window.openChat = (u) => {
            currentChatUser=u;
            chatId = currentUser.uid < u.uid ? `${currentUser.uid}_${u.uid}` : `${u.uid}_${currentUser.uid}`;
            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('chat-header').classList.remove('hidden');
            document.getElementById('input-bar').classList.remove('hidden');
            document.getElementById('chat-name').innerText = u.displayName;
            document.getElementById('chat-img').src = getAvatar(u);
            
            // Set About info
            document.getElementById('about-name').innerText = u.displayName;
            document.getElementById('about-img').src = getAvatar(u);
            document.getElementById('about-email').innerText = u.email;

            document.querySelector('.chat-area').classList.add('active');
            loadMessages();
        };

        window.sendMessage = async() => {
            const txt = document.getElementById('msg-input').value.trim();
            if(!txt) return;
            
            // Get Auto Delete Preference
            const hrs = document.getElementById('delete-timer').value;
            const expiresAt = new Date(Date.now() + (hrs * 60 * 60 * 1000)).toISOString();

            await addDoc(collection(db,"messages"),{
                text: txt, sender: currentUser.uid, chatId: chatId, 
                createdAt: serverTimestamp(), viewed: false, expiresAt: expiresAt
            });
            document.getElementById('msg-input').value = "";
        };

        function loadMessages() {
            const box = document.getElementById('messages');
            const q = query(collection(db,"messages"),where("chatId","==",chatId),orderBy("createdAt","asc"));
            onSnapshot(q,(snap)=>{
                box.innerHTML="";
                snap.forEach(d=>{
                    const data=d.data();
                    // Auto Delete Check
                    if(new Date() < new Date(data.expiresAt)) {
                        const isMe = data.sender === currentUser.uid;
                        if(!isMe && !data.viewed) updateDoc(doc(db,"messages",d.id), { viewed: true });

                        const div=document.createElement('div');
                        div.className=`msg ${isMe?'sent':'received'}`;
                        const ticks = isMe ? (data.viewed ? '<i class="fa fa-check-double tick seen"></i>' : '<i class="fa fa-check tick"></i>') : '';
                        const time = data.createdAt ? data.createdAt.toDate().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) : '...';
                        
                        div.innerHTML = `${data.text} <br><span style="font-size:10px; float:right; opacity:0.7;">${time} ${ticks}</span>`;
                        box.appendChild(div);
                    }
                });
                box.scrollTop=box.scrollHeight;
            });
        }

        // ABOUT USER
        window.toggleAbout = () => document.getElementById('about-modal').classList.toggle('hidden');

        // CALLS (Sensory Features)
        const ringtone = document.getElementById('ringtone');
        const connectTone = document.getElementById('connect-tone');

        function initPeer(uid){
            if(peer) return; peer=new Peer(uid);
            peer.on('call',(call)=>{
                activeCall=call; showIncomingUI(call.peer);
                ringtone.play(); // Play Ringtone
                if(navigator.vibrate) navigator.vibrate([500, 200, 500]); // Vibrate
                
                window.answerCall=()=>{
                    ringtone.pause(); ringtone.currentTime=0;
                    connectTone.play(); // Play Connect Sound
                    
                    navigator.mediaDevices.getUserMedia({audio:true}).then(s=>{
                        localStream=s; call.answer(s);
                        document.getElementById('call-status').innerText="Connected";
                        document.getElementById('inc-btns').classList.add('hidden');
                        document.getElementById('ong-btns').classList.remove('hidden');
                        call.on('stream',r=>{document.getElementById('remote-audio').srcObject=r});
                        call.on('close',closeCallUI);
                    });
                }
                window.rejectCall=()=>{
                    ringtone.pause(); ringtone.currentTime=0;
                    call.close(); closeCallUI();
                }
            });
        }

        window.startCallUI = async() => {
            document.getElementById('call-screen').classList.remove('hidden');
            document.getElementById('call-avatar').src = getAvatar(currentChatUser);
            document.getElementById('call-user').innerText = currentChatUser.displayName;
            document.getElementById('call-status').innerText = "Calling...";
            document.getElementById('inc-btns').classList.add('hidden');
            document.getElementById('ong-btns').classList.remove('hidden');
            
            if(navigator.vibrate) navigator.vibrate(200); // Haptic Feedback on button press

            try {
                localStream = await navigator.mediaDevices.getUserMedia({audio:true});
                const call = peer.call(currentChatUser.uid, localStream);
                activeCall = call;
                call.on('stream',r=>{
                    document.getElementById('remote-audio').srcObject=r;
                    document.getElementById('call-status').innerText="Connected";
                    connectTone.play(); // Play Connect Sound on answer
                });
                call.on('close', closeCallUI);
            } catch(e){ alert("Mic Denied"); closeCallUI(); }
        }

        window.endCall = () => { if(activeCall) activeCall.close(); closeCallUI(); }
        
        async function showIncomingUI(id) {
            const u = (await getDoc(doc(db,"users",id))).data();
            document.getElementById('call-screen').classList.remove('hidden');
            document.getElementById('call-avatar').src = getAvatar(u);
            document.getElementById('call-user').innerText = u.displayName;
            document.getElementById('inc-btns').classList.remove('hidden');
            document.getElementById('ong-btns').classList.add('hidden');
        }
        function closeCallUI() {
            document.getElementById('call-screen').classList.add('hidden');
            if(localStream) localStream.getTracks().forEach(t=>t.stop());
            ringtone.pause(); ringtone.currentTime=0;
        }

        // HELPERS
        window.switchTab=(t,b)=>{
            document.querySelectorAll('.list-area').forEach(e=>e.classList.add('hidden'));
            document.getElementById(`tab-${t}`).classList.remove('hidden');
            document.querySelectorAll('.tab-btn').forEach(x=>x.classList.remove('active'));
            b.classList.add('active');
        }
        window.closeChat = () => document.querySelector('.chat-area').classList.remove('active');
        window.changeDP=()=>{const i=document.createElement('input');i.type='file';i.onchange=async(e)=>{const f=e.target.files[0];if(!f)return;alert("Uploading...");const r=ref(storage,`dp/${currentUser.uid}`);await uploadBytes(r,f);const u=await getDownloadURL(r);await updateProfile(currentUser,{photoURL:u});await updateDoc(doc(db,"users",currentUser.uid),{photoURL:u});document.getElementById('my-dp').src=u;};i.click();}
        window.searchUsers=async(inpt)=>{const v=inpt.value.toLowerCase(); const b=document.getElementById('search-res'); if(v.length<3)return b.innerHTML=""; const q=query(collection(db,"users"),where("email",">=",v),where("email","<=",v+'\uf8ff')); const s=await getDocs(q); b.innerHTML=""; s.forEach(d=>{const u=d.data(); if(u.uid!==currentUser.uid) b.innerHTML+=`<div class="item"><img src="${getAvatar(u)}"><div><b>${u.displayName}</b></div><button onclick="sendReq('${u.uid}')" style="margin-left:auto; padding:5px 10px; background:var(--primary); color:white; border:none; border-radius:5px;">Add</button></div>`})};
        window.sendReq=async(uid)=>{await updateDoc(doc(db,"users",uid),{requests:arrayUnion(currentUser.uid)}); alert("Sent");}
        window.loadRequests=()=>{onSnapshot(doc(db,"users",currentUser.uid),async(s)=>{const b=document.getElementById('tab-requests'); b.innerHTML=""; const r=s.data().requests||[]; document.getElementById('req-cnt').innerText=r.length; for(const id of r){const u=(await getDoc(doc(db,"users",id))).data(); b.innerHTML+=`<div class="item"><img src="${getAvatar(u)}"><div><b>${u.displayName}</b> wants to join</div><button onclick="accReq('${id}')" style="margin-left:auto; padding:5px; background:green; color:white;">Accept</button></div>`}})};
        window.accReq=async(id)=>{await updateDoc(doc(db,"users",currentUser.uid),{requests:arrayRemove(id),friends:arrayUnion(id)}); await updateDoc(doc(db,"users",id),{friends:arrayUnion(currentUser.uid)});}
        window.loadFriends=()=>{onSnapshot(doc(db,"users",currentUser.uid),async(s)=>{const b=document.getElementById('tab-friends'); b.innerHTML=""; const f=s.data().friends||[]; for(const id of f){const u=(await getDoc(doc(db,"users",id))).data(); b.innerHTML+=`<div class="item" onclick="openChat({uid:'${u.uid}',displayName:'${u.displayName}',photoURL:'${u.photoURL}',email:'${u.email}'})"><img src="${getAvatar(u)}"><div><b>${u.displayName}</b><br><small>Tap to chat</small></div></div>`}})};
        window.login=async()=>{try{await signInWithEmailAndPassword(auth,document.getElementById('email').value,document.getElementById('password').value)}catch(e){alert(e.message)}};
        window.register=async()=>{try{const e=document.getElementById('email').value; const c=await createUserWithEmailAndPassword(auth,e,document.getElementById('password').value); await setDoc(doc(db,"users",c.user.uid),{uid:c.user.uid,email:e,displayName:e.split('@')[0],friends:[],requests:[]})}catch(e){alert(e.message)}};
        window.logout=()=>signOut(auth);
        window.forgotPass=()=>{const e=prompt("Email:");if(e)sendPasswordResetEmail(auth,e)};
    </script>
</body>
</html>
