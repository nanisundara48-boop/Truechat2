<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>True Chats Pro Max</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.1.0/fonts/remixicon.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

    <style>
        :root { --primary: #6366f1; --bg: #0f172a; --surface: #1e293b; --text: #f8fafc; }
        body.love-theme { --primary: #ec4899; --bg: #4a044e; --surface: #831843; }
        body { background-color: var(--bg); color: var(--text); font-family: 'Plus Jakarta Sans', sans-serif; overflow: hidden; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .msg-sent { background: var(--primary); border-radius: 18px 18px 0 18px; }
        .msg-recv { background: #334155; border-radius: 18px 18px 18px 0; }
        @keyframes beat { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }
        .heart-beat { animation: beat 1s infinite; color: #ff4d94 !important; }
    </style>
</head>
<body>

    <div id="auth-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-950">
        <div class="glass p-8 rounded-2xl w-full max-w-sm text-center">
            <h1 class="text-3xl font-bold text-indigo-400 mb-6">True Chats</h1>
            <input id="u-email" type="email" placeholder="Email" class="w-full p-3 mb-3 rounded-lg bg-slate-800 border border-slate-700 outline-none">
            <input id="u-pass" type="password" placeholder="Password" class="w-full p-3 mb-4 rounded-lg bg-slate-800 border border-slate-700 outline-none">
            <div id="signup-fields" class="hidden">
                <input id="u-name" type="text" placeholder="Display Name" class="w-full p-3 mb-4 rounded-lg bg-slate-800 border border-slate-700 outline-none">
            </div>
            <button onclick="handleAuth('login')" id="btn-main" class="w-full bg-indigo-600 py-3 rounded-lg font-bold mb-3">Login</button>
            <button onclick="toggleAuthMode()" id="btn-toggle" class="text-indigo-400 text-sm">Create Account</button>
        </div>
    </div>

    <div id="app-screen" class="hidden h-screen flex flex-col">
        <div class="h-16 border-b border-slate-800 flex items-center justify-between px-4 bg-slate-900">
            <h2 class="text-xl font-bold">Chats</h2>
            <div class="flex gap-4 text-xl">
                <i class="ri-user-search-line cursor-pointer" onclick="showSearch()"></i>
                <i id="theme-icon" class="ri-heart-line cursor-pointer" onclick="toggleTheme()"></i>
                <i class="ri-eye-off-line cursor-pointer" onclick="togglePrivacy()"></i>
            </div>
        </div>
        <div id="chat-list" class="flex-1 overflow-y-auto p-2 space-y-2"></div>
    </div>

    <div id="chat-view" class="fixed inset-0 bg-slate-950 z-40 hidden flex flex-col">
        <div class="h-16 border-b border-slate-800 flex items-center justify-between px-4 bg-slate-900">
            <div class="flex items-center gap-3">
                <i class="ri-arrow-left-line text-2xl" onclick="closeChat()"></i>
                <div class="leading-tight">
                    <h3 id="chat-header-name" class="font-bold">User</h3>
                    <span id="chat-header-status" class="text-xs text-slate-400">offline</span>
                </div>
            </div>
            <div class="flex gap-4 text-2xl text-indigo-400">
                <i class="ri-phone-fill" onclick="initiateCall('audio')"></i>
                <i class="ri-vidicon-fill" onclick="initiateCall('video')"></i>
                <div class="relative group">
                    <button onclick="toggleChatMenu()" class="font-bold">::::</button>
                    <div id="chat-menu" class="hidden absolute right-0 top-8 w-40 glass rounded-lg text-sm text-white">
                        <div class="p-3 border-b border-slate-700" onclick="hideChat()">Hide Chat ❤️</div>
                        <div class="p-3 text-red-400" onclick="blockUser()">Block</div>
                    </div>
                </div>
            </div>
        </div>
        <div id="msg-box" class="flex-1 overflow-y-auto p-4 space-y-4"></div>
        <div class="p-3 bg-slate-900 flex items-center gap-2">
            <input id="msg-input" type="text" placeholder="Type message..." class="flex-1 bg-slate-800 p-3 rounded-full outline-none border border-slate-700">
            <button onclick="sendMsg()" class="bg-indigo-600 p-3 rounded-full"><i class="ri-send-plane-fill"></i></button>
        </div>
    </div>

    <div id="call-overlay" class="fixed inset-0 bg-black z-[100] hidden flex flex-col items-center justify-center">
        <div class="text-center mb-10">
            <h2 id="call-user-name" class="text-3xl font-bold mb-2">User</h2>
            <p id="call-status" class="text-indigo-400 animate-pulse">Calling...</p>
        </div>
        <video id="remote-video" autoplay class="w-full h-1/2 object-cover bg-slate-900 mb-4"></video>
        <video id="local-video" autoplay muted class="absolute top-4 right-4 w-24 h-32 rounded-lg border border-white object-cover"></video>
        <div class="flex gap-10">
            <button onclick="acceptCall()" id="accept-btn" class="hidden bg-green-500 p-5 rounded-full text-3xl"><i class="ri-phone-fill"></i></button>
            <button onclick="endCall()" class="bg-red-500 p-5 rounded-full text-3xl"><i class="ri-phone-fill rotate-[135deg]"></i></button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, serverTimestamp, doc, setDoc, getDoc, orderBy, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // --- FIREBASE CONFIG (Updated from screenshot 66663.jpg) ---
        const firebaseConfig = {
            apiKey: "AIzaSyCAsCm1YcsAjHwyvIzxyMrBmZPLw2hlo18",
            authDomain: "truechats-8dac9.firebaseapp.com",
            projectId: "truechats-8dac9",
            storageBucket: "truechats-8dac9.firebasestorage.app",
            messagingSenderId: "685374771914",
            appId: "1:685374771914:web:81bf491264c1bb09061a33",
            measurementId: "G-7E9QE7G5SQ"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null, currentChat = null, peer = null, localStream = null, activeCall = null;

        // AUTH
        window.handleAuth = async (mode) => {
            const email = document.getElementById('u-email').value, pass = document.getElementById('u-pass').value;
            try {
                if (mode === 'reg') {
                    const res = await createUserWithEmailAndPassword(auth, email, pass);
                    await setDoc(doc(db, "users", res.user.uid), { 
                        uid: res.user.uid, email, displayName: document.getElementById('u-name').value, friends: [], hidden: [] 
                    });
                } else { await signInWithEmailAndPassword(auth, email, pass); }
            } catch (err) { alert(err.message); }
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app-screen').classList.remove('hidden');
                initApp();
            }
        });

        function initApp() {
            onSnapshot(doc(db, "users", currentUser.uid), async (snap) => {
                const data = snap.data();
                const list = document.getElementById('chat-list'); list.innerHTML = "";
                for (const id of data.friends || []) {
                    const f = (await getDoc(doc(db, "users", id))).data();
                    const div = document.createElement('div');
                    div.className = "p-4 glass rounded-xl flex justify-between items-center cursor-pointer";
                    div.onclick = () => openChat(f);
                    div.innerHTML = `<div><h4 class="font-bold">${f.displayName}</h4><p class="text-xs text-slate-400">Online</p></div><i class="ri-arrow-right-s-line"></i>`;
                    list.appendChild(div);
                }
            });
            initPeer();
        }

        // CHAT
        window.openChat = (user) => {
            currentChat = user;
            document.getElementById('chat-view').classList.remove('hidden');
            document.getElementById('chat-header-name').innerText = user.displayName;
            const chatId = [currentUser.uid, user.uid].sort().join("_");
            const q = query(collection(db, "messages"), where("chatId", "==", chatId), orderBy("ts", "asc"));
            onSnapshot(q, (snap) => {
                const box = document.getElementById('msg-box'); box.innerHTML = "";
                snap.forEach(d => {
                    const m = d.data(), isMe = m.from === currentUser.uid;
                    const div = document.createElement('div');
                    div.className = `flex ${isMe ? 'justify-end' : 'justify-start'}`;
                    div.innerHTML = `<div class="p-3 max-w-[80%] ${isMe ? 'msg-sent' : 'msg-recv'}">${m.txt}</div>`;
                    box.appendChild(div);
                });
                box.scrollTop = box.scrollHeight;
            });
        };

        window.sendMsg = async () => {
            const txt = document.getElementById('msg-input').value;
            if (!txt) return;
            const chatId = [currentUser.uid, currentChat.uid].sort().join("_");
            await addDoc(collection(db, "messages"), { chatId, from: currentUser.uid, txt, ts: serverTimestamp() });
            document.getElementById('msg-input').value = "";
        };

        // CALL LOGIC (DIRECT CALL FIX)
        function initPeer() {
            peer = new Peer(currentUser.uid);
            peer.on('call', (call) => {
                activeCall = call;
                document.getElementById('call-overlay').classList.remove('hidden');
                document.getElementById('accept-btn').classList.remove('hidden');
                document.getElementById('call-status').innerText = "Incoming Call...";
                getDoc(doc(db, "users", call.peer)).then(s => {
                    document.getElementById('call-user-name').innerText = s.data().displayName;
                });
            });
        }

        window.initiateCall = async (type) => {
            document.getElementById('call-overlay').classList.remove('hidden');
            document.getElementById('call-user-name').innerText = currentChat.displayName;
            document.getElementById('call-status').innerText = "Calling...";
            
            localStream = await navigator.mediaDevices.getUserMedia({ video: type === 'video', audio: true });
            document.getElementById('local-video').srcObject = localStream;
            
            const call = peer.call(currentChat.uid, localStream);
            activeCall = call;
            call.on('stream', (rs) => {
                document.getElementById('call-status').innerText = "Connected";
                document.getElementById('remote-video').srcObject = rs;
            });
        };

        window.acceptCall = async () => {
            localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            document.getElementById('local-video').srcObject = localStream;
            activeCall.answer(localStream);
            document.getElementById('accept-btn').classList.add('hidden');
            activeCall.on('stream', (rs) => {
                document.getElementById('call-status').innerText = "Connected";
                document.getElementById('remote-video').srcObject = rs;
            });
        };

        window.endCall = () => {
            if (activeCall) activeCall.close();
            if (localStream) localStream.getTracks().forEach(t => t.stop());
            document.getElementById('call-overlay').classList.add('hidden');
        };

        // UI HELPERS
        window.toggleTheme = () => {
            const body = document.body;
            body.classList.toggle('love-theme');
            const icon = document.getElementById('theme-icon');
            icon.className = body.classList.contains('love-theme') ? "ri-heart-fill heart-beat" : "ri-heart-line";
        };
        window.closeChat = () => document.getElementById('chat-view').classList.add('hidden');
        window.toggleAuthMode = () => {
            const fields = document.getElementById('signup-fields');
            const btn = document.getElementById('btn-main'), toggle = document.getElementById('btn-toggle');
            if (fields.classList.contains('hidden')) {
                fields.classList.remove('hidden');
                btn.innerText = "Create Account"; toggle.innerText = "Back to Login";
                window.authMode = 'reg';
            } else {
                fields.classList.add('hidden');
                btn.innerText = "Login"; toggle.innerText = "Create Account";
                window.authMode = 'login';
            }
        };
        window.handleAuth = (mode) => {
            const finalMode = window.authMode || mode;
            window.handleAuthMain(finalMode);
        };
        window.handleAuthMain = window.handleAuth;
        window.toggleChatMenu = () => document.getElementById('chat-menu').classList.toggle('hidden');
    </script>
</body>
</html>
