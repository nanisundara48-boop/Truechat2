<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TrueChats Pro Max</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.1.0/fonts/remixicon.css" rel="stylesheet">
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    
    <style>
        :root {
            --primary: #6366f1; --bg: #0f172a; --surface: #1e293b;
            --text: #f8fafc; --text-sec: #94a3b8; --border: #334155;
            --msg-sent: #4f46e5; --msg-recv: #334155;
            --success: #10b981; --danger: #ef4444;
            --gradient: none;
        }
        /* Love Theme Variables */
        body.love-theme {
            --primary: #ec4899; --bg: #831843; --surface: #9d174d;
            --text: #fff1f2; --text-sec: #fbcfe8; --border: #be185d;
            --msg-sent: #db2777; --msg-recv: #831843;
            --gradient: linear-gradient(135deg, #831843, #be185d);
        }

        * { margin:0; padding:0; box-sizing:border-box; font-family:'Plus Jakarta Sans',sans-serif; -webkit-tap-highlight-color:transparent; }
        body { background:var(--bg); color:var(--text); height:100dvh; overflow:hidden; display:flex; flex-direction:column; transition: background 0.5s; }
        body.love-theme { background: var(--gradient); }

        /* UI UTILS */
        .hidden { display:none !important; }
        .flex { display:flex; align-items:center; }
        .center { display:flex; justify-content:center; align-items:center; }
        .btn { background:none; border:none; cursor:pointer; color:var(--text); transition:0.2s; outline:none; padding: 8px; border-radius: 50%; }
        .btn:active { transform:scale(0.9); background: rgba(255,255,255,0.1); }
        .inp { width:100%; padding:14px; margin:10px 0; background:var(--bg); border:1px solid var(--border); color:white; border-radius:12px; outline:none; }
        .btn-main { width:100%; padding:14px; background:var(--primary); color:white; border-radius:12px; font-weight:700; border:none; cursor:pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        
        /* AUTH SCREEN */
        .auth-screen { position:fixed; inset:0; background:var(--bg); z-index:1000; }
        .auth-box { background:var(--surface); padding:35px; border-radius:24px; width:90%; max-width:380px; text-align:center; border:1px solid var(--border); box-shadow:0 25px 50px -12px rgba(0,0,0,0.5); }

        /* HEADER & SIDEBAR */
        .sidebar { width:100%; height:100%; display:flex; flex-direction:column; background:var(--surface); z-index:10; }
        .header { padding:15px 20px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; background:var(--surface); transition: background 0.3s; }
        .icon-btn { position: relative; cursor: pointer; font-size: 1.4rem; padding: 5px; color: var(--text-sec); }
        .icon-btn:hover { color: var(--text); }
        .red-dot { position: absolute; top: 0; right: 0; width: 10px; height: 10px; background: var(--danger); border-radius: 50%; border: 2px solid var(--surface); display: none; }
        
        /* LISTS */
        .list-area { flex:1; overflow-y:auto; padding:12px; background:var(--bg); }
        .item { display:flex; align-items:center; padding:14px; margin-bottom:10px; background:var(--surface); border-radius:16px; cursor:pointer; border:1px solid transparent; transition:0.2s; }
        .item:active { border-color:var(--primary); background:rgba(255,255,255,0.05); }
        .avatar { width:50px; height:50px; border-radius:50%; object-fit:cover; border:2px solid var(--border); background:#333; }
        
        /* CHAT VIEW */
        .chat-view { position:fixed; inset:0; background:var(--bg); z-index:500; transform:translateX(100%); transition:0.3s cubic-bezier(0.4, 0, 0.2, 1); display:flex; flex-direction:column; }
        .chat-view.active { transform:translateX(0); }
        .chat-header { padding:10px 15px; background:var(--surface); border-bottom:1px solid var(--border); display:flex; align-items:center; gap:10px; height:70px; }
        
        /* MESSAGES */
        .messages { flex:1; overflow-y:auto; padding:20px; display:flex; flex-direction:column; gap:8px; background-image: radial-gradient(var(--border) 1px, transparent 1px); background-size: 20px 20px; }
        .bubble { max-width:75%; padding:10px 16px; border-radius:20px; font-size:0.95rem; line-height:1.4; position:relative; word-wrap: break-word; }
        .sent { align-self:flex-end; background:var(--msg-sent); color:white; border-bottom-right-radius:2px; }
        .recv { align-self:flex-start; background:var(--msg-recv); color:var(--text); border-bottom-left-radius:2px; }
        .msg-info { font-size: 0.65rem; display: flex; justify-content: flex-end; gap: 4px; align-items: center; opacity: 0.8; margin-top: 4px; }

        /* 4 DOTS MENU */
        .menu-dropdown { position: absolute; top: 60px; right: 10px; background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 5px; width: 180px; z-index: 600; box-shadow: 0 10px 30px rgba(0,0,0,0.5); display: none; }
        .menu-item { padding: 10px; font-size: 0.9rem; cursor: pointer; border-radius: 8px; display: flex; align-items: center; gap: 10px; }
        .menu-item:hover { background: rgba(255,255,255,0.1); }
        .menu-item.danger { color: var(--danger); }

        /* REPLY BOX */
        .reply-preview { background: var(--surface); padding: 10px; border-left: 3px solid var(--primary); display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem; }

        /* CALL SCREEN */
        #call-screen { position: fixed; inset: 0; background:#000; z-index:2000; display: flex; flex-direction:column; align-items: center; justify-content: center; }
        #remote-vid { width:100%; height:100%; object-fit:cover; position: absolute; top: 0; left: 0; }
        #local-vid { position:absolute; top:20px; right:20px; width:100px; height:140px; border:2px solid white; border-radius:12px; object-fit:cover; z-index:2100; box-shadow:0 10px 25px rgba(0,0,0,0.5); }
        .call-controls { position:absolute; bottom:40px; display:flex; gap:25px; z-index:2200; width:100%; justify-content:center; }
        .c-btn { width:65px; height:65px; border-radius:50%; font-size:1.8rem; color:white; display:flex; justify-content:center; align-items:center; background:rgba(255,255,255,0.2); backdrop-filter:blur(10px); cursor: pointer; }
        .bg-red { background:var(--danger) !important; } .bg-green { background:var(--success) !important; }

        /* MODALS & ANIMATIONS */
        .modal { position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:3000; display:none; justify-content:center; align-items:center; backdrop-filter:blur(5px); }
        .heart-beat { animation: heartBeat 1.5s infinite; color: var(--danger) !important; }
        @keyframes heartBeat { 0%{transform:scale(1);} 14%{transform:scale(1.3);} 28%{transform:scale(1);} 42%{transform:scale(1.3);} 70%{transform:scale(1);} }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
    </style>
</head>
<body>

    <audio id="ring-out" src="https://assets.mixkit.co/active_storage/sfx/1359/1359-preview.mp3" loop></audio>
    <audio id="ring-in" src="https://assets.mixkit.co/active_storage/sfx/2346/2346-preview.mp3" loop></audio>

    <div id="auth-ui" class="auth-screen center">
        <div class="auth-box">
            <h1 style="color:var(--primary); font-family: 'Dancing Script', cursive; font-size: 3rem;">True Chats</h1>
            <p style="color:var(--text-sec); margin-bottom:20px;">Secure. Private. Yours.</p>
            <input id="reg-name" class="inp" placeholder="Display Name (For Signup)">
            <input id="u-email" class="inp" placeholder="Email Address">
            <input id="u-pass" type="password" class="inp" placeholder="Password">
            <button onclick="doAuth('login')" class="btn-main" style="margin-bottom:12px;">Login</button>
            <button onclick="doAuth('reg')" class="btn-main" style="background:transparent; border:1px solid var(--primary); color:var(--primary);">Create Account</button>
        </div>
    </div>

    <div id="app-ui" class="hidden" style="width:100%; height:100%; display:flex;">
        <div class="sidebar">
            <div class="header">
                <div class="flex" style="gap:10px;">
                    <h2 id="app-logo" style="font-family: 'Dancing Script', cursive; font-size: 1.8rem; font-weight: 700;">True Chats</h2>
                </div>
                <div class="flex" style="gap:15px;">
                    <div class="icon-btn" onclick="switchTab('reqs')">
                        <i class="ri-user-add-line"></i>
                        <div id="req-dot" class="red-dot"></div>
                    </div>
                    <div class="icon-btn" onclick="toggleLoveTheme()">
                        <i id="theme-icon" class="ri-heart-line" style="font-size: 1.5rem;"></i>
                    </div>
                    <div class="icon-btn" onclick="togglePrivacyMode()">
                        <i id="privacy-eye" class="ri-eye-off-line"></i>
                    </div>
                    <img id="my-pic" src="" class="avatar" style="width:35px; height:35px;" onclick="alert('Profile Settings: \nComing soon!')">
                </div>
            </div>

            <div class="flex" style="padding:10px; gap:10px; border-bottom:1px solid var(--border);">
                <input id="search-inp" class="inp" style="margin:0; padding:10px;" placeholder="Search friends..." onkeyup="filterChats(this.value)">
            </div>

            <div id="view-chats" class="list-area"></div>
            <div id="view-reqs" class="list-area hidden"></div>
        </div>
    </div>

    <div id="chat-ui" class="chat-view">
        <div class="chat-header">
            <button class="btn" onclick="closeChat()"><i class="ri-arrow-left-s-line" style="font-size:1.8rem;"></i></button>
            <img id="head-dp" class="avatar" style="width:40px; height:40px;">
            <div style="flex:1; cursor: pointer;" onclick="showUserDetails()">
                <h4 id="head-name" style="font-weight:700; line-height: 1.2;">User</h4>
                <small id="head-status" style="color:var(--success); font-size:0.75rem;">Online</small>
            </div>
            <div class="flex" style="gap:5px;">
                <button class="btn" onclick="startCall('voice')"><i class="ri-phone-fill"></i></button>
                <button class="btn" onclick="startCall('video')"><i class="ri-vidicon-fill" style="color: gold;"></i></button> <button class="btn" onclick="toggleMenu()" style="font-weight: bold; font-size: 1.2rem; letter-spacing: -2px;">::::</button>
                
                <div id="chat-menu" class="menu-dropdown">
                    <div class="menu-item" onclick="showUserDetails()"><i class="ri-user-line"></i> View Contact</div>
                    <div class="menu-item" onclick="alert('Muted Notifications')"><i class="ri-notification-off-line"></i> Mute Notif</div>
                    <div class="menu-item" onclick="hideCurrentChat()"><i class="ri-eye-off-fill" style="color:var(--primary)"></i> Hide Chat ❤️</div>
                    <div class="menu-item" onclick="toggleDisappear()"><i class="ri-timer-flash-line"></i> Disappear Msg</div>
                    <div class="menu-item danger" onclick="alert('User Blocked')"><i class="ri-forbid-2-line"></i> Block</div>
                </div>
            </div>
        </div>

        <div id="msg-box" class="messages"></div>

        <div id="reply-box" class="hidden reply-preview">
            <div>
                <b style="color:var(--primary); font-size:0.75rem;">Replying to...</b>
                <div id="reply-txt" style="opacity:0.8; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px;">Text</div>
            </div>
            <button class="btn" onclick="cancelReply()"><i class="ri-close-line"></i></button>
        </div>

        <div class="flex" style="padding:10px; background:var(--surface); gap:8px;">
            <div onclick="toggleSeenDelete()" style="display:flex; flex-direction:column; align-items:center; cursor:pointer;">
                <i id="sd-icon" class="ri-eye-close-line" style="color:var(--text-sec)"></i>
                <span style="font-size:0.6rem; color:var(--text-sec)">SeenDel</span>
            </div>

            <input id="msg-input" class="inp" style="margin:0; border-radius:30px; padding:12px 15px;" placeholder="Type message..." onkeypress="if(event.key==='Enter') sendMsg()">
            <button class="btn-main" style="width:45px; height:45px; border-radius:50%; padding:0; display:flex; align-items:center; justify-content:center;" onclick="sendMsg()"><i class="ri-send-plane-fill"></i></button>
        </div>
    </div>

    <div id="call-ui" class="hidden" style="position:fixed; inset:0; background:black; z-index:2000;">
        <video id="remote-vid" autoplay playsinline style="width:100%; height:100%; object-fit:cover;"></video>
        <video id="local-vid" autoplay playsinline muted style="position:absolute; top:20px; right:20px; width:100px; height:140px; border-radius:10px; border:2px solid white; object-fit:cover; z-index:2100;"></video>
        
        <div style="position:absolute; top:50px; left:20px; z-index:2200;">
            <h2 id="call-name" style="color:white; text-shadow:0 2px 4px rgba(0,0,0,0.8);">User</h2>
            <p id="call-status" style="color:gold; font-weight:bold;">Star Video Call...</p>
        </div>

        <div class="call-controls">
            <div id="inc-btns" class="hidden flex" style="gap:40px;">
                <div class="c-btn bg-red" onclick="rejectCall()"><i class="ri-phone-line" style="transform:rotate(135deg)"></i></div>
                <div class="c-btn bg-green" onclick="answerCall()"><i class="ri-phone-fill"></i></div>
            </div>
            <div id="act-btns" class="hidden flex" style="gap:20px;">
                <div class="c-btn" onclick="toggleMic()"><i class="ri-mic-line"></i></div>
                <div class="c-btn bg-red" onclick="endCall()"><i class="ri-phone-line" style="transform:rotate(135deg)"></i></div>
                <div class="c-btn" onclick="alert('Camera Switch')"><i class="ri-camera-switch-line"></i></div>
            </div>
        </div>
    </div>

    <div id="pass-modal" class="modal">
        <div class="auth-box">
            <i class="ri-lock-2-fill" style="font-size:2rem; color:var(--primary);"></i>
            <h3 id="modal-title" style="margin:10px 0;">Enter Privacy Password</h3>
            <input id="modal-pass" type="password" class="inp" style="text-align:center; font-size:1.5rem; letter-spacing:5px;" maxlength="4" placeholder="****">
            <button onclick="submitPass()" class="btn-main">Unlock</button>
            <button onclick="document.getElementById('pass-modal').style.display='none'" class="btn" style="margin-top:10px;">Cancel</button>
        </div>
    </div>

    <script type="module">
        // 1. FIREBASE CONFIG (Updated from Image 66096.jpg)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, serverTimestamp, updateDoc, doc, setDoc, getDoc, orderBy, arrayUnion, arrayRemove, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCAsCm1YcsAjHwyvIzxyMrBmZPLw2hlo18",
            authDomain: "truechats-8dac9.firebaseapp.com",
            projectId: "truechats-8dac9",
            storageBucket: "truechats-8dac9.firebasestorage.app",
            messagingSenderId: "685374771914",
            appId: "1:685374771914:web:81bf491264c1bb09061a33"
        };

        // Note: MongoDB Connection String (Reference only - cannot be used in client-side JS safely)
        // const mongoURI = "mongodb+srv://nani1248:nani1248@cluster0.jljbrjd.mongodb.net/?appName=Cluster0";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // STATE VARIABLES
        let currentUser = null;
        let currentChatUser = null;
        let chatId = null;
        let isLoveTheme = false;
        let isPrivateMode = false;
        let peer = null, localStream = null, activeCall = null;
        let replyToMsg = null;
        let editMsgId = null;
        let seenDeleteActive = false;
        let modalAction = null;

        // --- AUTHENTICATION ---
        onAuthStateChanged(auth, async(u) => {
            if (u) {
                currentUser = u;
                document.getElementById('auth-ui').classList.add('hidden');
                document.getElementById('app-ui').classList.remove('hidden');
                
                // Set DP (Initials if empty)
                const dp = u.photoURL || `https://ui-avatars.com/api/?name=${u.displayName}&background=random`;
                document.getElementById('my-pic').src = dp;

                // Update Firestore Status
                await setDoc(doc(db,"users",u.uid), {
                    uid: u.uid, email: u.email, displayName: u.displayName, 
                    photoURL: dp, lastSeen: serverTimestamp(), online: true
                }, { merge: true });

                initApp();
            } else {
                document.getElementById('auth-ui').classList.remove('hidden');
            }
        });

        window.doAuth = async (type) => {
            const e = document.getElementById('u-email').value;
            const p = document.getElementById('u-pass').value;
            const n = document.getElementById('reg-name').value;
            try {
                if(type === 'reg'){
                    const res = await createUserWithEmailAndPassword(auth, e, p);
                    await updateProfile(res.user, { displayName: n });
                    location.reload();
                } else {
                    await signInWithEmailAndPassword(auth, e, p);
                }
            } catch(err) { alert(err.message); }
        }

        // --- THEME & UI ---
        window.toggleLoveTheme = () => {
            isLoveTheme = !isLoveTheme;
            document.body.classList.toggle('love-theme');
            const icon = document.getElementById('theme-icon');
            if(isLoveTheme){
                icon.className = "ri-heart-fill heart-beat";
                icon.style.color = "white"; // White heart on red bg
            } else {
                icon.className = "ri-heart-line";
                icon.style.color = "var(--text-sec)";
            }
        };

        window.toggleMenu = () => {
            const m = document.getElementById('chat-menu');
            m.style.display = m.style.display === 'block' ? 'none' : 'block';
        }

        // --- PRIVACY MODE ---
        window.togglePrivacyMode = () => {
            // Check if Password is set (Mock check)
            modalAction = 'toggle_mode';
            document.getElementById('pass-modal').style.display = 'flex';
        };

        window.submitPass = async () => {
            const pass = document.getElementById('modal-pass').value;
            // Demo Password is '1234'
            if(pass === '1234') {
                const pass = document.getElementById('modal-pass').value;
            // Demo Password is '1234'
            if(pass === '1234') {
                document.getElementById('pass-modal').style.display = 'none';
                document.getElementById('modal-pass').value = '';
                
                if(modalAction === 'toggle_mode') {
                    isPrivateMode = !isPrivateMode;
                    const icon = document.getElementById('privacy-eye');
                    icon.className = isPrivateMode ? "ri-eye-fill" : "ri-eye-off-line";
                    icon.style.color = isPrivateMode ? "var(--danger)" : "var(--text-sec)";
                    loadChats(); // Reload list based on mode
                } else if(modalAction === 'hide_chat') {
                    // Logic to add user to hidden array in Firestore
                    await updateDoc(doc(db,"users",currentUser.uid), {
                        hidden: arrayUnion(currentChatUser.uid)
                    });
                    alert("Chat Hidden! Enable Private Mode to view.");
                    closeChat();
                }
            } else {
                alert("Wrong Password!");
            }
        };

        window.hideCurrentChat = () => {
            modalAction = 'hide_chat';
            document.getElementById('pass-modal').style.display = 'flex';
        };

        // --- CHAT LIST ---
        function initApp() {
            loadChats();
            initPeer();
            // Listen for Requests
            onSnapshot(doc(db,"users",currentUser.uid), (doc) => {
                const reqs = doc.data()?.requests || [];
                document.getElementById('req-dot').style.display = reqs.length > 0 ? 'block' : 'none';
                if(reqs.length > 0) loadReqs(reqs);
            });
        }

        function loadChats() {
            onSnapshot(doc(db, "users", currentUser.uid), async (snap) => {
                const data = snap.data();
                const friendIds = data?.friends || [];
                const hiddenIds = data?.hidden || [];
                
                const list = document.getElementById('view-chats');
                list.innerHTML = "";

                for (const fid of friendIds) {
                    // Privacy Filter
                    if (isPrivateMode) {
                        if (!hiddenIds.includes(fid)) continue; // Show only hidden
                    } else {
                        if (hiddenIds.includes(fid)) continue; // Show only normal
                    }

                    const fDoc = await getDoc(doc(db, "users", fid));
                    if (fDoc.exists()) {
                        const f = fDoc.data();
                        const div = document.createElement('div');
                        div.className = 'item';
                        div.onclick = () => openChat(f);
                        div.innerHTML = `
                            <img src="${f.photoURL}" class="avatar">
                            <div style="flex:1; margin-left:10px;">
                                <div class="flex" style="justify-content:space-between">
                                    <b>${f.displayName} ${hiddenIds.includes(fid) ? '❤️' : ''}</b>
                                    <small style="opacity:0.6">10:00 AM</small>
                                </div>
                                <small style="opacity:0.7">Tap to chat...</small>
                            </div>
                        `;
                        list.appendChild(div);
                    }
                }
            });
        }

        // --- CHAT MESSAGING ---
        window.openChat = (user) => {
            currentChatUser = user;
            chatId = [currentUser.uid, user.uid].sort().join("_");
            document.getElementById('chat-ui').classList.add('active');
            
            document.getElementById('head-name').innerText = user.displayName;
            document.getElementById('head-dp').src = user.photoURL;
            document.getElementById('head-status').innerText = user.online ? 'Online' : 'Offline';

            // Load Messages
            onSnapshot(query(collection(db, "messages"), where("chatId", "==", chatId), orderBy("ts", "asc")), (snap) => {
                const box = document.getElementById('msg-box');
                box.innerHTML = "";
                snap.forEach(doc => {
                    const m = doc.data();
                    renderMessage(m, doc.id, box);
                });
                box.scrollTop = box.scrollHeight;
            });
        };

        function renderMessage(m, id, box) {
            const isMe = m.from === currentUser.uid;
            const div = document.createElement('div');
            div.className = `bubble ${isMe ? 'sent' : 'recv'}`;
            
            // Double Click to Reply
            div.ondblclick = () => {
                replyToMsg = { id, txt: m.txt };
                document.getElementById('reply-box').classList.remove('hidden');
                document.getElementById('reply-txt').innerText = m.txt;
            };

            // Seen -> Delete Logic
            if(m.seenDelete && m.to === currentUser.uid && !m.seen){
               // Mark seen then delete (simulated)
               updateDoc(doc(db, "messages", id), { seen: true });
               setTimeout(() => deleteDoc(doc(db, "messages", id)), 2000); 
            }

            let content = "";
            if(m.replyTo) content += `<div style="font-size:0.7rem; opacity:0.7; border-left:2px solid white; padding-left:5px; margin-bottom:5px;">Replying: ${m.replyTo.txt}</div>`;
            content += `${m.txt} ${m.edited ? '<small>(edited)</small>' : ''}`;
            content += `<div class="msg-info">${new Date(m.ts?.toDate()).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})} 
                        ${isMe ? (m.seen ? '<i class="ri-check-double-line" style="color:#93c5fd"></i>' : '<i class="ri-check-line"></i>') : ''}</div>`;
            
            div.innerHTML = content;
            box.appendChild(div);
        }

        window.sendMsg = async () => {
            const txt = document.getElementById('msg-input').value;
            if(!txt) return;

            if(editMsgId) {
                // Update Message (Edit)
                await updateDoc(doc(db, "messages", editMsgId), { txt: txt, edited: true });
                editMsgId = null;
            } else {
                // New Message
                await addDoc(collection(db, "messages"), {
                    chatId, from: currentUser.uid, to: currentChatUser.uid,
                    txt, ts: serverTimestamp(), seen: false,
                    replyTo: replyToMsg, seenDelete: seenDeleteActive
                });
            }
            
            document.getElementById('msg-input').value = "";
            cancelReply();
        };

        window.cancelReply = () => {
            replyToMsg = null;
            document.getElementById('reply-box').classList.add('hidden');
        };

        window.toggleSeenDelete = () => {
            seenDeleteActive = !seenDeleteActive;
            const icon = document.getElementById('sd-icon');
            icon.className = seenDeleteActive ? "ri-eye-line" : "ri-eye-close-line";
            icon.style.color = seenDeleteActive ? "var(--primary)" : "var(--text-sec)";
        };

        // --- VIDEO CALL (PeerJS) ---
        function initPeer() {
            peer = new Peer(currentUser.uid);
            peer.on('call', (call) => {
                activeCall = call;
                document.getElementById('call-ui').classList.remove('hidden');
                document.getElementById('inc-btns').classList.remove('hidden');
                document.getElementById('act-btns').classList.add('hidden');
                document.getElementById('call-status').innerText = "Incoming Call...";
                document.getElementById('ring-in').play();
                
                window.answerCall = async () => {
                    document.getElementById('ring-in').pause();
                    document.getElementById('inc-btns').classList.add('hidden');
                    document.getElementById('act-btns').classList.remove('hidden');
                    
                    try {
                        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                        document.getElementById('local-vid').srcObject = localStream;
                        call.answer(localStream);
                        call.on('stream', (rs) => { document.getElementById('remote-vid').srcObject = rs; });
                    } catch(e) { alert("Mic/Camera Denied! Check Permissions."); endCall(); }
                };
            });
        }

        window.startCall = async (type) => {
            document.getElementById('call-ui').classList.remove('hidden');
            document.getElementById('inc-btns').classList.add('hidden');
            document.getElementById('act-btns').classList.remove('hidden');
            document.getElementById('call-name').innerText = currentChatUser.displayName;
            document.getElementById('ring-out').play();

            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: type==='video', audio: true });
                if(type === 'video') document.getElementById('local-vid').srcObject = localStream;
                
                const call = peer.call(currentChatUser.uid, localStream);
                activeCall = call;
                call.on('stream', (rs) => { 
                    document.getElementById('ring-out').pause();
                    document.getElementById('remote-vid').srcObject = rs; 
                    document.getElementById('call-status').innerText = "Connected";
                });
            } catch(e) { alert("Permission Error: " + e.message); endCall(); }
        };

        window.endCall = () => {
            if(activeCall) activeCall.close();
            if(localStream) localStream.getTracks().forEach(t => t.stop());
            document.getElementById('call-ui').classList.add('hidden');
            document.getElementById('ring-in').pause();
            document.getElementById('ring-out').pause();
            location.reload(); // Quick reset
        };

        // --- UTILS ---
        window.closeChat = () => document.getElementById('chat-ui').classList.remove('active');
        window.loadReqs = async (reqIds) => {
            const list = document.getElementById('view-reqs');
            list.innerHTML = "";
            for(const id of reqIds){
                const u = (await getDoc(doc(db,"users",id))).data();
                list.innerHTML += `<div class="item">
                    <b>${u.displayName}</b>
                    <button class="btn-main" style="width:auto; padding:5px 15px; margin-left:auto;" onclick="acceptReq('${u.uid}')">Accept</button>
                </div>`;
            }
        };
        window.acceptReq = async(id) => {
            await updateDoc(doc(db,"users",currentUser.uid), { friends: arrayUnion(id), requests: arrayRemove(id) });
            await updateDoc(doc(db,"users",id), { friends: arrayUnion(currentUser.uid) });
            alert("Friend Added!");
            location.reload();
        };
        window.switchTab = (tab) => {
            if(tab === 'reqs') {
                document.getElementById('view-chats').classList.add('hidden');
                document.getElementById('view-reqs').classList.remove('hidden');
            }
        };

    </script>
</body>
</html>
