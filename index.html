<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TrueChats X</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    
    <style>
        /* --- VARIABLES & BASICS --- */
        :root {
            --primary: #008069; --primary-dark: #005c4b;
            --bg-grad: linear-gradient(135deg, #008069, #25D366);
            --chat-bg: #efeae2; 
            --sent: #d9fdd3; --received: #ffffff;
            --text: #111; --white: #fff;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Outfit', sans-serif; }
        body { height: 100dvh; overflow: hidden; background: #e0e0e0; position: relative; }
        .hidden { display: none !important; }
        .center { display: flex; justify-content: center; align-items: center; }
        .flex-col { display: flex; flex-direction: column; }

        /* --- INTRO ANIMATION --- */
        #intro-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 9999; display: flex; justify-content: center; align-items: center;
            flex-direction: column; transition: opacity 0.8s ease;
        }
        .intro-logo { font-size: 40px; font-weight: bold; color: var(--primary); letter-spacing: 2px; animation: scaleUp 1s ease forwards; }
        @keyframes scaleUp { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* --- "nc" LOADER --- */
        .nc-loader {
            width: 50px; height: 50px; border-radius: 50%; background: var(--primary);
            color: white; font-weight: bold; font-size: 20px; display: flex; justify-content: center; align-items: center;
            animation: spin 1s infinite linear; margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- AUTH --- */
        #auth-screen { position: fixed; width: 100%; height: 100%; background: var(--bg-grad); z-index: 2000; }
        .card { background: rgba(255,255,255,0.95); padding: 30px; border-radius: 20px; width: 90%; max-width: 350px; text-align: center; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        input { width: 100%; padding: 14px; margin-bottom: 10px; border: 1px solid #ddd; background: #f9f9f9; border-radius: 8px; outline: none; }
        .btn { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 16px; margin-top: 5px; }

        /* --- APP STRUCTURE --- */
        #app-screen { display: flex; height: 100%; background: white; }
        .sidebar { width: 350px; display: flex; flex-direction: column; border-right: 1px solid #ddd; background: white; z-index: 10; }
        
        .header { padding: 15px; background: #f0f2f5; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ddd; }
        .my-dp { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; cursor: pointer; border: 2px solid var(--primary); }
        
        .tabs { display: flex; background: var(--primary); padding: 0; }
        .tab-btn { flex: 1; padding: 12px; background: transparent; border: none; color: rgba(255,255,255,0.7); cursor: pointer; font-weight: 600; border-bottom: 3px solid transparent; }
        .tab-btn.active { color: white; border-bottom: 3px solid white; }

        .list-area { flex: 1; overflow-y: auto; padding: 10px; }
        .item { display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: 0.2s; }
        .item:hover { background: #f5f5f5; }
        .item img { width: 50px; height: 50px; border-radius: 50%; margin-right: 15px; object-fit: cover; }

        /* --- CHAT AREA --- */
        .chat-area { flex: 1; display: flex; flex-direction: column; background: var(--chat-bg); position: relative; }
        .chat-area::before { content: ""; position: absolute; width: 100%; height: 100%; opacity: 0.4; background-image: url("https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png"); pointer-events: none; }

        .chat-header { padding: 10px 15px; background: #f0f2f5; display: flex; align-items: center; height: 60px; z-index: 2; border-bottom: 1px solid #ddd; }
        .chat-header img { width: 40px; height: 40px; border-radius: 50%; margin: 0 10px; object-fit: cover; }
        
        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 5px; z-index: 1; }
        
        .msg { max-width: 75%; padding: 8px 12px; border-radius: 8px; font-size: 14.5px; position: relative; word-wrap: break-word; box-shadow: 0 1px 1px rgba(0,0,0,0.1); margin-bottom: 2px; }
        .sent { align-self: flex-end; background: var(--sent); color: var(--text); border-top-right-radius: 0; }
        .received { align-self: flex-start; background: var(--received); color: var(--text); border-top-left-radius: 0; }
        
        .meta { font-size: 10px; float: right; margin-top: 5px; margin-left: 5px; color: #777; display: flex; align-items: center; gap: 3px; }
        .seen { color: #53bdeb; } /* Blue Ticks */

        /* View Once Style */
        .view-once-bubble { background: #e0e0e0; color: #333; cursor: pointer; display: flex; align-items: center; gap: 5px; font-style: italic; }
        .view-once-bubble i { color: var(--primary); }

        .input-bar { padding: 8px 10px; background: #f0f2f5; display: flex; align-items: center; gap: 8px; z-index: 2; }
        .input-bar input { flex: 1; padding: 12px 20px; border-radius: 30px; border: none; background: white; outline: none; }
        .icon-btn { width: 40px; height: 40px; border-radius: 50%; border: none; background: transparent; color: #54656f; font-size: 20px; cursor: pointer; display: flex; justify-content: center; align-items: center; }
        .icon-btn.send { background: var(--primary); color: white; }

        /* --- CALL SCREEN --- */
        #call-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0f1c24; z-index: 5000; flex-direction: column; color: white; }
        #call-avatar { width: 150px; height: 150px; border-radius: 50%; margin-bottom: 20px; border: 3px solid rgba(255,255,255,0.2); animation: ringPulse 1.5s infinite; }
        @keyframes ringPulse { 0% { box-shadow: 0 0 0 0 rgba(0, 128, 105, 0.7); } 70% { box-shadow: 0 0 0 20px rgba(0, 128, 105, 0); } 100% { box-shadow: 0 0 0 0 rgba(0, 0, 0, 0); } }
        
        .call-actions { display: flex; gap: 40px; margin-top: 60px; }
        .c-btn { width: 65px; height: 65px; border-radius: 50%; border: none; font-size: 24px; cursor: pointer; display: flex; justify-content: center; align-items: center; color: white; transition: 0.2s; }
        .bg-red { background: #ff3b30; } .bg-green { background: #2ecc71; } .bg-grey { background: rgba(255,255,255,0.2); }

        /* MODALS */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 3000; }
        .modal-content { background: white; width: 85%; max-width: 300px; padding: 20px; border-radius: 10px; }
        .opt { padding: 12px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }

        /* MOBILE */
        @media (max-width: 768px) {
            .sidebar { width: 100%; height: 100%; }
            .chat-area { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 50; transform: translateX(100%); transition: 0.3s ease-in-out; }
            .chat-area.active { transform: translateX(0); }
            .back-btn { display: block !important; margin-right: 15px; font-size: 20px; cursor: pointer; }
        }
        .back-btn { display: none; }
    </style>
</head>
<body>

    <div id="intro-screen">
        <div class="intro-logo">TrueChats</div>
    </div>

    <audio id="remote-audio" autoplay></audio>
    <audio id="ringtone" loop src="https://assets.mixkit.co/active_storage/sfx/1359/1359-preview.mp3"></audio>
    <audio id="pop-sound" src="https://assets.mixkit.co/active_storage/sfx/2346/2346-preview.mp3"></audio>

    <div id="auth-screen" class="center">
        <div class="card">
            <h2 style="color:var(--primary); margin-bottom:10px;">Welcome Back</h2>
            <input type="email" id="email" placeholder="Email">
            <input type="password" id="password" placeholder="Password">
            <button onclick="login()" class="btn">Login</button>
            <button onclick="register()" class="btn" style="background:#444;">Register</button>
            <p onclick="forgotPass()" style="margin-top:15px; font-size:12px; color:#666; cursor:pointer;">Forgot Password?</p>
        </div>
    </div>

    <div id="settings-modal" class="modal center hidden" onclick="this.classList.add('hidden')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3>Settings</h3>
            <div class="opt">
                <span>Disappearing Messages</span>
                <select id="auto-del" style="padding:5px;">
                    <option value="24">24 Hours</option>
                    <option value="48" selected>48 Hours</option>
                    <option value="720">Off</option>
                </select>
            </div>
            <div class="opt" onclick="changeName()"><span>Change Nickname</span> <i class="fa fa-pencil"></i></div>
            <div class="opt" onclick="logout()" style="color:red;"><span>Logout</span> <i class="fa fa-power-off"></i></div>
        </div>
    </div>

    <div id="app-screen" class="hidden">
        <div class="sidebar">
            <div class="header">
                <div class="center" style="gap:10px;">
                    <img id="my-dp" class="my-dp" src="" onclick="changeDP()">
                    <div>
                        <h3 id="my-name" style="font-size:16px;">User</h3>
                        <span style="font-size:12px; color:gray;">Online</span>
                    </div>
                </div>
                <div class="center" style="gap:20px;">
                    <i class="fa fa-ellipsis-v" onclick="document.getElementById('settings-modal').classList.remove('hidden')" style="cursor:pointer; color:#54656f; font-size:20px;"></i>
                </div>
            </div>

            <div class="tabs">
                <button onclick="switchTab('friends', this)" class="tab-btn active">CHATS</button>
                <button onclick="switchTab('search', this)" class="tab-btn">SEARCH</button>
                <button onclick="switchTab('requests', this)" class="tab-btn">REQUESTS</button>
            </div>

            <div id="tab-friends" class="list-area">
                <div class="nc-loader">nc</div> </div>
            
            <div id="tab-search" class="list-area hidden">
                <input type="text" placeholder="Search users..." onkeyup="searchUsers(this)" style="width:100%;">
                <div id="search-res"></div>
            </div>
            
            <div id="tab-requests" class="list-area hidden"></div>
        </div>

        <div id="chat-area" class="chat-area">
            <div id="chat-header" class="chat-header hidden">
                <i class="fa fa-arrow-left back-btn" onclick="closeChat()"></i>
                <img id="chat-img" src="">
                <div style="flex:1; margin-left:10px; cursor:pointer;" onclick="showUserInfo()">
                    <h3 id="chat-name" style="font-size:16px;">User</h3>
                    <small style="font-size:12px;">Tap for info</small>
                </div>
                <i class="fa fa-phone" onclick="startCallUI()" style="font-size:22px; color:var(--primary); cursor:pointer; margin-right:15px;"></i>
                <i class="fa fa-ban" onclick="blockUser()" style="font-size:20px; color:#red; cursor:pointer;" title="Block"></i>
            </div>

            <div id="messages"></div>

            <div id="input-bar" class="input-bar hidden">
                <button class="icon-btn" onclick="sendViewOnce()" title="1-Time View"><i class="fa fa-eye-slash"></i></button>
                <input type="text" id="msg-input" placeholder="Message...">
                <button class="icon-btn send" onclick="sendMessage()"><i class="fa fa-paper-plane"></i></button>
            </div>

            <div id="empty-state" class="center flex-col" style="height:100%; color:#888;">
                <i class="fa fa-comments" style="font-size:80px; margin-bottom:20px; opacity:0.3;"></i>
                <p>Select a chat to start</p>
                <p style="font-size:12px; margin-top:10px;"><i class="fa fa-lock"></i> End-to-end encrypted</p>
            </div>
        </div>
    </div>

    <div id="call-screen" class="center hidden">
        <img id="call-avatar" src="">
        <h2 id="call-user">User</h2>
        <p id="call-status">Calling...</p>
        
        <div id="inc-btns" class="hidden call-actions">
            <button class="c-btn bg-red" onclick="rejectCall()"><i class="fa fa-phone-slash"></i></button>
            <button class="c-btn bg-green" onclick="answerCall()"><i class="fa fa-phone"></i></button>
        </div>
        
        <div id="ong-btns" class="hidden call-actions">
            <button class="c-btn bg-grey" onclick="toggleSpeaker()"><i class="fa fa-volume-up"></i></button>
            <button class="c-btn bg-grey" onclick="toggleMute()"><i class="fa fa-microphone-slash"></i></button>
            <button class="c-btn bg-red" onclick="endCall()"><i class="fa fa-phone-slash"></i></button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, serverTimestamp, updateDoc, doc, setDoc, getDoc, getDocs, orderBy, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";

        // CONFIG (Replace if needed)
        const config={apiKey:"AIzaSyCAsCm1YcsAjHwyvIzxyMrBmZPLw2hlo18",authDomain:"truechats-8dac9.firebaseapp.com",projectId:"truechats-8dac9",storageBucket:"truechats-8dac9.firebasestorage.app",messagingSenderId:"685374771914",appId:"1:685374771914:web:81bf491264c1bb09061a33"};
        const app=initializeApp(config); const auth=getAuth(app); const db=getFirestore(app); const storage=getStorage(app);

        let currentUser, currentChatUser, chatId, peer, activeCall, localStream;
        const getAvatar=(u)=>u.photoURL||`https://ui-avatars.com/api/?name=${u.displayName}&background=random&color=fff&size=128`;

        // AUTH & INTRO
        onAuthStateChanged(auth, async(u)=>{
            const intro = document.getElementById('intro-screen');
            if(u){
                currentUser=u;
                // Show Intro then Hide
                setTimeout(()=>{ intro.style.opacity='0'; setTimeout(()=>intro.classList.add('hidden'),800); }, 1500);
                
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app-screen').classList.remove('hidden');
                document.getElementById('my-name').innerText = u.displayName;
                document.getElementById('my-dp').src = getAvatar(u);
                await setDoc(doc(db,"users",u.uid),{uid:u.uid,email:u.email.toLowerCase(),displayName:u.displayName,photoURL:u.photoURL},{merge:true});
                initPeer(u.uid); loadFriends(); loadRequests();
            } else {
                intro.classList.add('hidden');
                document.getElementById('auth-screen').classList.remove('hidden');
                document.getElementById('app-screen').classList.add('hidden');
            }
        });

        // CHAT ENGINE
        window.openChat = (u) => {
            currentChatUser=u;
            chatId = currentUser.uid < u.uid ? `${currentUser.uid}_${u.uid}` : `${u.uid}_${currentUser.uid}`;
            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('chat-header').classList.remove('hidden');
            document.getElementById('input-bar').classList.remove('hidden');
            document.getElementById('chat-name').innerText = u.displayName;
            document.getElementById('chat-img').src = getAvatar(u);
            document.querySelector('.chat-area').classList.add('active');
            loadMessages();
        };

        window.sendMessage = async(viewOnce=false, fileUrl=null) => {
            const txt = document.getElementById('msg-input').value.trim();
            if(!txt && !fileUrl) return;
            
            const hours = document.getElementById('auto-del').value;
            const expires = new Date(Date.now() + (hours * 60 * 60 * 1000)).toISOString();

            try {
                await addDoc(collection(db,"messages"),{
                    text: fileUrl ? "Photo" : txt,
                    fileUrl: fileUrl, viewOnce: viewOnce, viewed: false,
                    sender: currentUser.uid, chatId: chatId, createdAt: serverTimestamp(),
                    expiresAt: expires
                });
                document.getElementById('msg-input').value = "";
                // Play sound
                document.getElementById('pop-sound').play();
            } catch(e) {
                alert("Message Failed! Check console for Index Error.");
                console.error(e);
            }
        };

        function loadMessages() {
            const box = document.getElementById('messages');
            // NOTE: If this fails, Firestore Index is needed. Check Console.
            const q = query(collection(db,"messages"),where("chatId","==",chatId),orderBy("createdAt","asc"));
            
            onSnapshot(q, (snap) => {
                box.innerHTML = "";
                snap.forEach(d => {
                    const data = d.data();
                    if(new Date() < new Date(data.expiresAt)) {
                        const isMe = data.sender === currentUser.uid;
                        if(!isMe && !data.viewed) updateDoc(doc(db,"messages",d.id), {viewed:true});

                        const div = document.createElement('div');
                        div.className = `msg ${isMe?'sent':'received'}`;
                        
                        let content = data.text;
                        if(data.fileUrl) {
                            if(data.viewOnce) {
                                if(isMe) content = `<div class="view-once-bubble"><i class="fa fa-1"></i> View Once Photo</div>`;
                                else content = data.viewed ? `<i>Photo Opened</i>` : `<div class="view-once-bubble" onclick="openViewOnce('${data.fileUrl}', '${d.id}')"><i class="fa fa-1"></i> View Photo</div>`;
                            } else {
                                content = `<img src="${data.fileUrl}" style="width:200px; border-radius:10px;">`;
                            }
                        }

                        const time = data.createdAt ? data.createdAt.toDate().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) : '...';
                        const ticks = isMe ? (data.viewed ? '<i class="fa fa-check-double seen"></i>' : '<i class="fa fa-check"></i>') : '';

                        div.innerHTML = `${content} <div class="meta">${time} ${ticks}</div>`;
                        box.appendChild(div);
                    }
                });
                box.scrollTop = box.scrollHeight;
            }, (error) => {
                console.error("INDEX ERROR:", error);
                box.innerHTML = `<p style="text-align:center; color:red; margin-top:20px;">Error loading chats. <br> Open Console to create Firestore Index.</p>`;
            });
        }

        window.openViewOnce = (url, id) => {
            window.open(url, '_blank');
            updateDoc(doc(db,"messages",id), {viewed:true});
        };

        window.sendViewOnce = () => {
            const i=document.createElement('input'); i.type='file'; i.accept='image/*';
            i.onchange=async(e)=>{
                const f=e.target.files[0]; if(!f) return;
                alert("Sending 1-Time View Photo...");
                const r=ref(storage,`media/${Date.now()}`);
                await uploadBytes(r,f);
                sendMessage(true, await getDownloadURL(r));
            }; i.click();
        };

        // CALLS (Sensory)
        function initPeer(uid){
            if(peer) return; peer=new Peer(uid);
            peer.on('call',(call)=>{
                activeCall=call; showIncomingUI(call.peer);
                // Sensory: Vibrate & Ring
                if(navigator.vibrate) navigator.vibrate([1000, 500, 1000]);
                document.getElementById('ringtone').play();
                
                window.answerCall=()=>{
                    document.getElementById('ringtone').pause();
                    navigator.mediaDevices.getUserMedia({audio:true}).then(s=>{
                        localStream=s; call.answer(s);
                        document.getElementById('call-status').innerText="Connected";
                        document.getElementById('pop-sound').play(); // Connect Sound
                        document.getElementById('inc-btns').classList.add('hidden');
                        document.getElementById('ong-btns').classList.remove('hidden');
                        call.on('stream',r=>document.getElementById('remote-audio').srcObject=r);
                        call.on('close',closeCallUI);
                    });
                }
                window.rejectCall=()=>{ document.getElementById('ringtone').pause(); call.close(); closeCallUI(); }
            });
        }

        window.startCallUI = async() => {
            document.getElementById('call-screen').classList.remove('hidden');
            document.getElementById('call-avatar').src = getAvatar(currentChatUser);
            document.getElementById('call-user').innerText = currentChatUser.displayName;
            document.getElementById('call-status').innerText = "Calling...";
            document.getElementById('inc-btns').classList.add('hidden');
            document.getElementById('ong-btns').classList.remove('hidden');
            
            // Haptic
            if(navigator.vibrate) navigator.vibrate(50);

            try{
                localStream = await navigator.mediaDevices.getUserMedia({audio:true});
                const call = peer.call(currentChatUser.uid, localStream);
                activeCall = call;
                call.on('stream',r=>{
                    document.getElementById('remote-audio').srcObject=r;
                    document.getElementById('call-status').innerText="Connected";
                    document.getElementById('pop-sound').play();
                });
                call.on('close', closeCallUI);
            } catch(e){ alert("Mic Denied"); closeCallUI(); }
        }

        window.endCall = () => { if(activeCall) activeCall.close(); closeCallUI(); };
        
        async function showIncomingUI(id) {
            const u = (await getDoc(doc(db,"users",id))).data();
            document.getElementById('call-screen').classList.remove('hidden');
            document.getElementById('call-avatar').src = getAvatar(u);
            document.getElementById('call-user').innerText = u.displayName;
            document.getElementById('call-status').innerText = "Incoming Call...";
            document.getElementById('inc-btns').classList.remove('hidden');
            document.getElementById('ong-btns').classList.add('hidden');
        }
        function closeCallUI() {
            document.getElementById('call-screen').classList.add('hidden');
            document.getElementById('ringtone').pause(); document.getElementById('ringtone').currentTime=0;
            if(localStream) localStream.getTracks().forEach(t=>t.stop());
        }

        // HELPERS
        window.switchTab=(t,b)=>{
            document.querySelectorAll('.list-area').forEach(e=>e.classList.add('hidden'));
            document.getElementById(`tab-${t}`).classList.remove('hidden');
            document.querySelectorAll('.tab-btn').forEach(x=>x.classList.remove('active'));
            b.classList.add('active');
        }
        window.closeChat = () => document.querySelector('.chat-area').classList.remove('active');
        window.changeDP=()=>{const i=document.createElement('input');i.type='file';i.onchange=async(e)=>{const f=e.target.files[0];if(!f)return;alert("Uploading...");const r=ref(storage,`dp/${currentUser.uid}`);await uploadBytes(r,f);const u=await getDownloadURL(r);await updateProfile(currentUser,{photoURL:u});await updateDoc(doc(db,"users",currentUser.uid),{photoURL:u});document.getElementById('my-dp').src=u;};i.click();}
        window.searchUsers=async(inpt)=>{const v=inpt.value.toLowerCase(); const b=document.getElementById('search-res'); if(v.length<3)return b.innerHTML=""; const q=query(collection(db,"users"),where("email",">=",v),where("email","<=",v+'\uf8ff')); const s=await getDocs(q); b.innerHTML=""; s.forEach(d=>{const u=d.data(); if(u.uid!==currentUser.uid) b.innerHTML+=`<div class="item"><img src="${getAvatar(u)}"><div><b>${u.displayName}</b></div><button onclick="sendReq('${u.uid}')" style="margin-left:auto; padding:5px 10px; background:var(--primary); color:white; border:none; border-radius:5px;">Add</button></div>`})};
        window.sendReq=async(uid)=>{await updateDoc(doc(db,"users",uid),{requests:arrayUnion(currentUser.uid)}); alert("Sent");}
        window.loadRequests=()=>{onSnapshot(doc(db,"users",currentUser.uid),async(s)=>{const b=document.getElementById('tab-requests'); b.innerHTML=""; const r=s.data().requests||[]; for(const id of r){const u=(await getDoc(doc(db,"users",id))).data(); b.innerHTML+=`<div class="item"><img src="${getAvatar(u)}"><div><b>${u.displayName}</b> wants to join</div><button onclick="accReq('${id}')" style="margin-left:auto; padding:5px; background:green; color:white;">Accept</button></div>`}})};
        window.accReq=async(id)=>{await updateDoc(doc(db,"users",currentUser.uid),{requests:arrayRemove(id),friends:arrayUnion(id)}); await updateDoc(doc(db,"users",id),{friends:arrayUnion(currentUser.uid)});}
        window.loadFriends=()=>{onSnapshot(doc(db,"users",currentUser.uid),async(s)=>{const b=document.getElementById('tab-friends'); b.innerHTML=""; const f=s.data().friends||[]; 
            if(f.length===0) b.innerHTML='<div class="center" style="margin-top:20px; color:gray;">No chats yet</div>';
            for(const id of f){const u=(await getDoc(doc(db,"users",id))).data(); b.innerHTML+=`<div class="item" onclick="openChat({uid:'${u.uid}',displayName:'${u.displayName}',photoURL:'${u.photoURL}',email:'${u.email}'})"><img src="${getAvatar(u)}"><div><b>${u.displayName}</b><br><small>Tap to chat</small></div></div>`}
        })};
        window.login=async()=>{try{await signInWithEmailAndPassword(auth,document.getElementById('email').value,document.getElementById('password').value)}catch(e){alert(e.message)}};
        window.register=async()=>{try{const e=document.getElementById('email').value; const c=await createUserWithEmailAndPassword(auth,e,document.getElementById('password').value); await setDoc(doc(db,"users",c.user.uid),{uid:c.user.uid,email:e,displayName:e.split('@')[0],friends:[],requests:[]})}catch(e){alert(e.message)}};
        window.logout=()=>signOut(auth);
        window.forgotPass=()=>{const e=prompt("Email:");if(e)sendPasswordResetEmail(auth,e)};
        window.changeName=async()=>{const n=prompt("New Name:",currentUser.displayName); if(n){await updateProfile(currentUser,{displayName:n});await updateDoc(doc(db,"users",currentUser.uid),{displayName:n});document.getElementById('my-name').innerText=n;}}
        window.blockUser=async()=>{if(confirm("Block User?")){alert("Blocked (Visual Only)");}}
        window.showUserInfo=()=>{alert(`Name: ${currentChatUser.displayName}\nEmail: ${currentChatUser.email}`);}
    </script>
</body>
</html>
