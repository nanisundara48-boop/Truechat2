<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TrueChats v3</title>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    
    <style>
        :root {
            --primary: #6366f1; --bg: #0f172a; --surface: #1e293b;
            --text: #f8fafc; --text-sec: #94a3b8; --border: #334155;
            --success: #22c55e; --danger: #ef4444;
        }
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Manrope',sans-serif; -webkit-tap-highlight-color:transparent; }
        body { background:var(--bg); color:var(--text); height:100dvh; overflow:hidden; display:flex; flex-direction:column; }
        
        /* UTILS */
        .hidden { display:none !important; }
        .flex { display:flex; align-items:center; }
        .col { flex-direction:column; }
        .center { display:flex; justify-content:center; align-items:center; }
        .btn { border:none; outline:none; cursor:pointer; }
        
        /* --- SCREENS --- */
        .screen { position:fixed; inset:0; z-index:50; background:var(--bg); }
        
        /* AUTH */
        .auth-box { background:var(--surface); padding:25px; border-radius:20px; width:90%; max-width:350px; border:1px solid var(--border); text-align:center; }
        .inp { width:100%; padding:14px; margin:8px 0; background:var(--bg); border:1px solid var(--border); border-radius:10px; color:white; outline:none; }
        .btn-main { width:100%; padding:14px; background:var(--primary); color:white; border-radius:10px; font-weight:600; margin-top:10px; transition:0.2s; }
        .btn-main:active { transform:scale(0.98); }

        /* APP LAYOUT */
        .app-layout { display:flex; width:100%; height:100%; }
        .sidebar { width:100%; height:100%; display:flex; flex-direction:column; background:var(--surface); z-index:10; }
        
        /* HEADER & TABS */
        .header { padding:15px; border-bottom:1px solid var(--border); justify-content:space-between; display:flex; align-items:center; }
        .my-info img { width:45px; height:45px; border-radius:50%; object-fit:cover; border:2px solid var(--primary); background:#333; }
        
        .tabs { display:flex; padding:10px; gap:10px; background:var(--surface); overflow-x:auto; }
        .tab-btn { flex:1; padding:10px 15px; background:transparent; color:var(--text-sec); font-weight:600; border-radius:8px; white-space:nowrap; transition:0.3s; text-align:center; }
        .tab-btn.active { background:var(--primary); color:white; box-shadow:0 4px 12px rgba(99,102,241,0.3); }

        /* LISTS */
        .list-area { flex:1; overflow-y:auto; padding:10px; background:var(--bg); }
        .user-card { display:flex; align-items:center; padding:12px; margin-bottom:8px; background:var(--surface); border-radius:12px; cursor:pointer; border:1px solid transparent; }
        .user-card:active { border-color:var(--border); transform:scale(0.99); }
        .uc-img { width:50px; height:50px; border-radius:50%; object-fit:cover; background:#333; margin-right:15px; }
        
        /* CHAT WINDOW */
        .chat-screen { position:fixed; inset:0; background:var(--bg); z-index:20; transform:translateX(100%); transition:0.3s ease-in-out; display:flex; flex-direction:column; }
        .chat-screen.active { transform:translateX(0); }
        .chat-head { padding:10px 15px; background:var(--surface); border-bottom:1px solid var(--border); display:flex; align-items:center; gap:10px; }
        .chat-msgs { flex:1; overflow-y:auto; padding:15px; display:flex; flex-direction:column; gap:8px; }
        
        .bubble { max-width:75%; padding:10px 15px; border-radius:18px; font-size:0.95rem; line-height:1.4; word-wrap:break-word; }
        .sent { align-self:flex-end; background:var(--primary); color:white; border-bottom-right-radius:2px; }
        .recv { align-self:flex-start; background:var(--surface); color:var(--text); border-bottom-left-radius:2px; }
        
        .chat-input { padding:10px; background:var(--surface); display:flex; gap:10px; align-items:center; }
        .chat-input input { flex:1; padding:12px; border-radius:25px; border:none; background:var(--bg); color:white; outline:none; }

        /* CALL UI */
        #call-ui { background:#000; z-index:100; flex-direction:column; }
        #remote-vid { width:100%; height:100%; object-fit:cover; }
        #local-vid { position:absolute; bottom:100px; right:20px; width:100px; height:140px; border-radius:10px; background:#333; border:2px solid white; object-fit:cover; z-index:110; }
        .controls { position:absolute; bottom:30px; display:flex; gap:20px; z-index:120; }
        .c-btn { width:60px; height:60px; border-radius:50%; font-size:1.5rem; color:white; display:flex; justify-content:center; align-items:center; }
        .bg-r { background:var(--danger); } .bg-g { background:var(--success); } .bg-b { background:rgba(255,255,255,0.2); }

        /* IMAGE FALLBACK */
        img { display: block; }
    </style>
</head>
<body>

    <audio id="ring-out" src="https://assets.mixkit.co/active_storage/sfx/1359/1359-preview.mp3" loop></audio>
    <audio id="ring-in" src="https://assets.mixkit.co/active_storage/sfx/2346/2346-preview.mp3" loop></audio>

    <div id="auth-view" class="screen center">
        <div class="auth-box">
            <h2 style="margin-bottom:5px;">TrueChats v3</h2>
            <p style="color:var(--text-sec); margin-bottom:20px;">Ultimate Connection</p>
            <input id="u-name" class="inp" placeholder="Your Name">
            <input id="u-email" class="inp" placeholder="Email">
            <input id="u-pass" type="password" class="inp" placeholder="Password">
            <button onclick="doLogin()" class="btn btn-main">Login</button>
            <button onclick="doReg()" class="btn btn-main" style="background:transparent; border:1px solid var(--primary);">Register</button>
        </div>
    </div>

    <div id="app-view" class="app-layout hidden">
        <div class="sidebar">
            <div class="header">
                <div class="my-info flex" style="gap:10px;">
                    <img id="my-pic" src="" onerror="this.src='https://ui-avatars.com/api/?background=random&color=fff&name=User'">
                    <div>
                        <h4 id="my-n">User</h4>
                        <small style="color:var(--success)">Online</small>
                    </div>
                </div>
                <button class="btn" style="color:var(--danger); font-size:1.2rem;" onclick="doLogout()"><i class="ri-logout-box-line"></i></button>
            </div>

            <div class="tabs">
                <button class="btn tab-btn active" onclick="setTab('chats', this)">Chats</button>
                <button class="btn tab-btn" onclick="setTab('calls', this)">Calls</button>
                <button class="btn tab-btn" onclick="setTab('search', this)">Search</button>
                <button class="btn tab-btn" onclick="setTab('reqs', this)">Requests</button>
            </div>

            <div id="view-chats" class="list-area"></div>
            <div id="view-calls" class="list-area hidden"></div>
            <div id="view-search" class="list-area hidden">
                <input class="inp" placeholder="Search User Email..." onkeyup="findUser(this.value)">
                <div id="search-res" style="margin-top:10px;"></div>
            </div>
            <div id="view-reqs" class="list-area hidden"></div>
        </div>
    </div>

    <div id="chat-ui" class="chat-screen">
        <div class="chat-head">
            <button class="btn" onclick="closeChat()" style="color:white; font-size:1.5rem;"><i class="ri-arrow-left-line"></i></button>
            <img id="c-pic" src="" class="uc-img" style="width:40px; height:40px; margin:0;" onerror="this.src='https://ui-avatars.com/api/?background=random&color=fff&name=User'">
            <div style="flex:1;">
                <h4 id="c-name">User</h4>
            </div>
            <button class="btn" style="color:var(--primary); font-size:1.4rem; margin-right:15px;" onclick="call('audio')"><i class="ri-phone-line"></i></button>
            <button class="btn" style="color:var(--primary); font-size:1.4rem;" onclick="call('video')"><i class="ri-vidicon-line"></i></button>
        </div>
        <div id="msg-box" class="chat-msgs"></div>
        <div class="chat-input">
            <input id="txt-in" placeholder="Message...">
            <button class="btn" style="background:var(--primary); color:white; width:40px; height:40px; border-radius:50%;" onclick="send()"><i class="ri-send-plane-fill"></i></button>
        </div>
    </div>

    <div id="call-ui" class="screen center hidden">
        <video id="remote-vid" autoplay playsinline></video>
        <video id="local-vid" autoplay playsinline muted></video>
        <div class="controls">
            <div id="inc-action" class="hidden flex" style="gap:20px;">
                <button class="btn c-btn bg-r" onclick="reject()"><i class="ri-phone-close-line"></i></button>
                <button class="btn c-btn bg-g" onclick="answer()"><i class="ri-phone-answer-line"></i></button>
            </div>
            <div id="out-action" class="flex" style="gap:20px;">
                <button class="btn c-btn bg-r" onclick="end()"><i class="ri-phone-close-line"></i></button>
            </div>
        </div>
        <h2 id="call-stat" style="position:absolute; top:100px; color:white; text-shadow:0 2px 5px black;">Connecting...</h2>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, serverTimestamp, updateDoc, doc, setDoc, getDoc, getDocs, orderBy, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";

        // CONFIG
        const config={apiKey:"AIzaSyCAsCm1YcsAjHwyvIzxyMrBmZPLw2hlo18",authDomain:"truechats-8dac9.firebaseapp.com",projectId:"truechats-8dac9",storageBucket:"truechats-8dac9.firebasestorage.app",messagingSenderId:"685374771914",appId:"1:685374771914:web:81bf491264c1bb09061a33"};
        const app=initializeApp(config); const auth=getAuth(app); const db=getFirestore(app); const storage=getStorage(app);

        let me, chatUser, chatId, peer, localSt, actCall;

        // AUTH
        onAuthStateChanged(auth, async(u)=>{
            if(u){
                me=u;
                document.getElementById('auth-view').classList.add('hidden');
                document.getElementById('app-view').classList.remove('hidden');
                
                // Safe Data Handling
                const dp = u.photoURL || `https://ui-avatars.com/api/?name=${u.email}&background=random`;
                const nm = u.displayName || u.email.split('@')[0];
                
                document.getElementById('my-pic').src = dp;
                document.getElementById('my-n').innerText = nm;

                await setDoc(doc(db,"users",u.uid),{uid:u.uid, email:u.email, displayName:nm, photoURL:dp},{merge:true});
                
                initPeer(); loadChats(); loadReqs(); loadCalls();
            } else {
                document.getElementById('auth-view').classList.remove('hidden');
            }
        });

        // GLOBAL FUNCS
        window.doLogin=async()=>{ try{ await signInWithEmailAndPassword(auth,document.getElementById('u-email').value,document.getElementById('u-pass').value) }catch(e){alert(e.message)} }
        window.doReg=async()=>{ 
            const n = document.getElementById('u-name').value;
            if(!n) return alert("Name Required");
            try{ 
                const r = await createUserWithEmailAndPassword(auth,document.getElementById('u-email').value,document.getElementById('u-pass').value);
                await updateProfile(r.user, {displayName:n});
                location.reload();
            }catch(e){alert(e.message)} 
        }
        window.doLogout=()=>signOut(auth);

        // TAB SWITCHING (ROBUST)
        window.setTab=(t, el)=>{
            ['chats','calls','search','reqs'].forEach(x=>document.getElementById(`view-${x}`).classList.add('hidden'));
            document.getElementById(`view-${t}`).classList.remove('hidden');
            document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
            el.classList.add('active');
        }

        // DATA LOADING (Image Error Fixed)
        window.loadChats=()=>{
            onSnapshot(doc(db,"users",me.uid), async(s)=>{
                const f = s.data()?.friends || [];
                const d = document.getElementById('view-chats'); d.innerHTML="";
                if(f.length===0) d.innerHTML="<p style='text-align:center; padding:20px; color:#666;'>No chats yet. Search to add!</p>";
                
                for(const id of f){
                    const ud = await getDoc(doc(db,"users",id));
                    if(ud.exists()){
                        const u = ud.data();
                        const pic = u.photoURL || `https://ui-avatars.com/api/?name=${u.displayName}`;
                        d.innerHTML += `
                        <div class="user-card" onclick="startChat('${u.uid}')">
                            <img src="${pic}" class="uc-img" onerror="this.src='https://ui-avatars.com/api/?name=User'">
                            <div>
                                <b>${u.displayName || 'Unknown'}</b><br>
                                <small style="color:var(--text-sec)">Tap to chat</small>
                            </div>
                        </div>`;
                    }
                }
            });
        }

        // CHAT
        window.startChat=async(uid)=>{
            const ud = await getDoc(doc(db,"users",uid));
            chatUser = ud.data();
            chatId = [me.uid, chatUser.uid].sort().join("_");
            
            document.getElementById('chat-ui').classList.add('active');
            document.getElementById('c-name').innerText = chatUser.displayName;
            document.getElementById('c-pic').src = chatUser.photoURL || `https://ui-avatars.com/api/?name=${chatUser.displayName}`;
            
            const box = document.getElementById('msg-box');
            onSnapshot(query(collection(db,"messages"), where("chatId","==",chatId), orderBy("ts","asc")), (snap)=>{
                box.innerHTML="";
                snap.forEach(d=>{
                    const m = d.data();
                    const div = document.createElement('div');
                    div.className = `bubble ${m.from===me.uid ? 'sent':'recv'}`;
                    div.innerText = m.txt;
                    box.appendChild(div);
                });
                box.scrollTop=box.scrollHeight;
            });
        }
        window.closeChat=()=>document.getElementById('chat-ui').classList.remove('active');
        window.send=async()=>{
            const t = document.getElementById('txt-in').value;
            if(!t)return;
            await addDoc(collection(db,"messages"), {txt:t, from:me.uid, chatId, ts:serverTimestamp()});
            document.getElementById('txt-in').value="";
        }

        // SEARCH & REQ
        window.findUser=async(v)=>{
            if(v.length<3) return;
            const q = query(collection(db,"users"), where("email",">=",v), where("email","<=",v+'\uf8ff'));
            const s = await getDocs(q);
            const d = document.getElementById('search-res'); d.innerHTML="";
            s.forEach(doc=>{
                const u = doc.data();
                if(u.uid!==me.uid) d.innerHTML += `<div class="user-card"><div style="flex:1"><b>${u.displayName}</b><br><small>${u.email}</small></div> <button class="btn" style="background:var(--primary); padding:5px 10px; border-radius:5px; color:white;" onclick="sendReq('${u.uid}')">Add</button></div>`;
            });
        }
        window.sendReq=async(uid)=>{ await updateDoc(doc(db,"users",uid),{requests:arrayUnion(me.uid)}); alert("Sent!"); }
        window.loadReqs=()=>{
            onSnapshot(doc(db,"users",me.uid), async(s)=>{
                const r = s.data()?.requests || [];
                const d = document.getElementById('view-reqs'); d.innerHTML="";
                if(r.length===0) d.innerHTML="<p style='text-align:center; padding:20px; color:#666;'>No requests</p>";
                for(const id of r){
                    const u = (await getDoc(doc(db,"users",id))).data();
                    d.innerHTML += `<div class="user-card"><img src="${u.photoURL}" class="uc-img"> <div style="flex:1"><b>${u.displayName}</b> wants to join</div> <button class="btn" onclick="accReq('${u.uid}')" style="background:var(--success); color:white; padding:5px 10px; border-radius:5px;">Accept</button></div>`;
                }
            });
        }
        window.accReq=async(id)=>{
            await updateDoc(doc(db,"users",me.uid),{friends:arrayUnion(id), requests:arrayRemove(id)});
            await updateDoc(doc(db,"users",id),{friends:arrayUnion(me.uid)});
        }

        // CALLING
        function initPeer(){
            peer = new Peer(me.uid);
            peer.on('call', (c)=>{
                actCall=c;
                document.getElementById('call-ui').classList.remove('hidden');
                document.getElementById('inc-action').classList.remove('hidden');
                document.getElementById('out-action').classList.add('hidden');
                document.getElementById('call-stat').innerText = "Incoming Call...";
                document.getElementById('ring-in').play();
                
                window.answer=async()=>{
                    document.getElementById('ring-in').pause();
                    localSt = await navigator.mediaDevices.getUserMedia({video:true, audio:true});
                    c.answer(localSt);
                    handleStream(c);
                }
            });
        }
        window.call=async(type)=>{
            document.getElementById('call-ui').classList.remove('hidden');
            document.getElementById('inc-action').classList.add('hidden');
            document.getElementById('out-action').classList.remove('hidden');
            document.getElementById('ring-out').play();
            
            try{
                localSt = await navigator.mediaDevices.getUserMedia({video:type==='video', audio:true});
                if(type==='video') document.getElementById('local-vid').srcObject=localSt;
                const c = peer.call(chatUser.uid, localSt);
                actCall=c;
                handleStream(c);
                
                // Log Call
                await addDoc(collection(db,"calls"),{caller:me.uid, type, time:serverTimestamp()});
                
            }catch(e){ alert("Mic Error: "+e.message); closeCall(); }
        }
        function handleStream(c){
            c.on('stream', (rs)=>{
                document.getElementById('remote-vid').srcObject=rs;
                document.getElementById('ring-out').pause();
                document.getElementById('call-stat').innerText="";
                document.getElementById('inc-action').classList.add('hidden');
                document.getElementById('out-action').classList.remove('hidden');
            });
            c.on('close', closeCall);
        }
        window.end=()=>{ if(actCall) actCall.close(); closeCall(); }
        window.reject=()=>{ document.getElementById('ring-in').pause(); if(actCall) actCall.close(); closeCall(); }
        function closeCall(){
            document.getElementById('call-ui').classList.add('hidden');
            if(localSt) localSt.getTracks().forEach(t=>t.stop());
            document.getElementById('ring-in').pause();
            document.getElementById('ring-out').pause();
            location.reload(); // Safe Reset
        }
        window.loadCalls=()=>{
            onSnapshot(query(collection(db,"calls"), where("caller","==",me.uid), orderBy("time","desc")), (s)=>{
                const d = document.getElementById('view-calls'); d.innerHTML="";
                s.forEach(doc=>{
                    const c = doc.data();
                    if(new Date()-c.time?.toDate() < 172800000) d.innerHTML += `<div class="user-card"><div><b>Outgoing ${c.type}</b><br><small>${c.time?.toDate().toLocaleString()}</small></div></div>`;
                });
            });
        }
    </script>
</body>
</html>
